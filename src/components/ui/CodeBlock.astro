---
import { Code } from 'astro:components';

interface Props {
  code: string;
  lang: 'tsx' | 'vue' | 'svelte' | 'astro' | 'typescript' | 'javascript' | 'html' | 'css';
  title?: string;
  collapsible?: boolean;
  collapsedLines?: number;
}

const { code, lang, title, collapsible = false, collapsedLines = 3 } = Astro.props;

const lines = code.split('\n');
const lineCount = lines.length;
const shouldCollapse = collapsible && lineCount > collapsedLines;
const blockId = `code-block-${Math.random().toString(36).substring(2, 9)}`;
---

<div class="code-block" data-collapsible={shouldCollapse ? 'true' : undefined}>
  {
    title && (
      <div class="code-block-header">
        <span class="code-block-title">{title}</span>
        <button class="copy-button" data-code={code} aria-label="Copy code to clipboard">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
            <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
          </svg>
          <span class="copy-feedback sr-only" aria-live="polite" />
        </button>
      </div>
    )
  }
  <div
    id={blockId}
    class:list={['code-block-content', { 'code-collapsed': shouldCollapse }]}
    data-collapsed-lines={shouldCollapse ? collapsedLines : undefined}
  >
    <Code code={code} lang={lang} theme="github-dark" />
  </div>
  {
    shouldCollapse && (
      <div class="code-block-toggle">
        <button
          class="toggle-button"
          aria-expanded="false"
          aria-controls={blockId}
          data-line-count={lineCount}
        >
          <svg
            class="toggle-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="6 9 12 15 18 9" />
          </svg>
          <span class="toggle-text">Show more ({lineCount} lines)</span>
        </button>
      </div>
    )
  }
</div>

<style>
  .code-block {
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid var(--border);
    margin-bottom: 1rem;
  }

  .code-block-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background-color: #1f2937;
    border-bottom: 1px solid #374151;
  }

  .code-block-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #9ca3af;
  }

  .code-block-header :global(.copy-button) {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.375rem;
    border-radius: 0.25rem;
    background: transparent;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    transition:
      color 0.2s,
      background-color 0.2s;
  }

  .code-block-header :global(.copy-button:hover) {
    background-color: #374151;
    color: #f3f4f6;
  }

  .code-block-header :global(.copy-button:focus-visible) {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .code-block-content {
    overflow-x: auto;
  }

  .code-block-content :global(pre) {
    margin: 0;
    padding: 1rem;
    border-radius: 0;
  }

  .code-block-content :global(pre:focus-visible) {
    outline: 2px solid var(--ring);
    outline-offset: -2px;
  }

  /* Collapsed state */
  .code-collapsed {
    position: relative;
    max-height: calc(1.5rem * var(--collapsed-lines, 3) + 2rem);
    overflow: hidden;
  }

  .code-collapsed::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3rem;
    background: linear-gradient(to bottom, transparent, #24292e);
    pointer-events: none;
  }

  /* Expanded state */
  .code-expanded {
    max-height: none;
  }

  .code-expanded::after {
    display: none;
  }

  /* Toggle button */
  .code-block-toggle {
    background-color: #1f2937;
    border-top: 1px solid #374151;
    padding: 0.5rem 1rem;
  }

  .toggle-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem;
    background: transparent;
    border: none;
    color: #9ca3af;
    font-size: 0.875rem;
    cursor: pointer;
    transition:
      color 0.2s,
      background-color 0.2s;
    border-radius: 0.25rem;
  }

  .toggle-button:hover {
    background-color: #374151;
    color: #f3f4f6;
  }

  .toggle-button:focus-visible {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .toggle-icon {
    transition: transform 0.2s;
  }

  .toggle-button[aria-expanded='true'] .toggle-icon {
    transform: rotate(180deg);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>

<script>
  function initCodeBlocks() {
    // Copy button functionality
    document.querySelectorAll('.copy-button').forEach((button) => {
      button.addEventListener('click', async () => {
        const code = button.getAttribute('data-code');
        const feedback = button.querySelector('.copy-feedback');

        if (code && feedback) {
          try {
            await navigator.clipboard.writeText(code);
            feedback.textContent = 'Copied!';
            setTimeout(() => {
              feedback.textContent = '';
            }, 2000);
          } catch {
            feedback.textContent = 'Failed to copy';
          }
        }
      });
    });

    // Toggle button functionality
    document.querySelectorAll('.toggle-button').forEach((button) => {
      button.addEventListener('click', () => {
        const contentId = button.getAttribute('aria-controls');
        const content = contentId ? document.getElementById(contentId) : null;
        const lineCount = button.getAttribute('data-line-count');

        if (content) {
          const isExpanded = content.classList.contains('code-expanded');

          if (isExpanded) {
            content.classList.remove('code-expanded');
            content.classList.add('code-collapsed');
            button.setAttribute('aria-expanded', 'false');
            const textEl = button.querySelector('.toggle-text');
            if (textEl) {
              textEl.textContent = `Show more (${lineCount} lines)`;
            }
          } else {
            content.classList.remove('code-collapsed');
            content.classList.add('code-expanded');
            button.setAttribute('aria-expanded', 'true');
            const textEl = button.querySelector('.toggle-text');
            if (textEl) {
              textEl.textContent = 'Show less';
            }
          }
        }
      });
    });

    // Set CSS variable for collapsed lines
    document.querySelectorAll('.code-collapsed').forEach((el) => {
      const lines = el.getAttribute('data-collapsed-lines');
      if (lines) {
        (el as HTMLElement).style.setProperty('--collapsed-lines', lines);
      }
    });
  }

  // Initialize on page load
  initCodeBlocks();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', initCodeBlocks);
</script>
