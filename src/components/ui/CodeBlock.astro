---
import { Code } from 'astro:components';

interface Props {
  code: string;
  lang: 'tsx' | 'vue' | 'svelte' | 'typescript' | 'javascript' | 'html' | 'css';
  title?: string;
  showLineNumbers?: boolean;
}

const { code, lang, title, showLineNumbers = true } = Astro.props;
---

<div class="code-block">
  {title && (
    <div class="code-block-header">
      <span class="code-block-title">{title}</span>
      <button
        class="copy-button"
        data-code={code}
        aria-label="Copy code to clipboard"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
          <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
        </svg>
        <span class="copy-feedback sr-only" aria-live="polite"></span>
      </button>
    </div>
  )}
  <div class="code-block-content">
    <Code code={code} lang={lang} theme="github-dark" />
  </div>
</div>

<style>
  .code-block {
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid var(--border);
    margin-bottom: 1rem;
  }

  .code-block-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background-color: #1f2937;
    border-bottom: 1px solid #374151;
  }

  .code-block-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #9ca3af;
  }

  .copy-button {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.375rem;
    border-radius: 0.25rem;
    background: transparent;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    transition: color 0.2s, background-color 0.2s;
  }

  .copy-button:hover {
    background-color: #374151;
    color: #f3f4f6;
  }

  .copy-button:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  .code-block-content {
    overflow-x: auto;
  }

  .code-block-content :global(pre) {
    margin: 0;
    padding: 1rem;
    border-radius: 0;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>

<script>
  document.querySelectorAll('.copy-button').forEach((button) => {
    button.addEventListener('click', async () => {
      const code = button.getAttribute('data-code');
      const feedback = button.querySelector('.copy-feedback');

      if (code && feedback) {
        try {
          await navigator.clipboard.writeText(code);
          feedback.textContent = 'Copied!';
          setTimeout(() => {
            feedback.textContent = '';
          }, 2000);
        } catch {
          feedback.textContent = 'Failed to copy';
        }
      }
    });
  });
</script>
