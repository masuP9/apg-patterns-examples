---
/**
 * Prose component for styling MDX-generated content
 *
 * Provides typography styles for headings, paragraphs, lists, tables,
 * code blocks, links, and blockquotes using project design tokens.
 * Also adds collapsible functionality to code blocks.
 */
interface Props {
  class?: string;
  /** Minimum lines for code block to be collapsible */
  collapsedLines?: number;
}

const { class: className, collapsedLines = 5 } = Astro.props;
---

<article class:list={['prose', className]} data-collapsed-lines={collapsedLines}>
  <slot />
</article>

<style>
  .prose {
    /* Base typography */
    color: var(--foreground);
    line-height: 1.75;
    max-width: none;
  }

  /* Headings */
  .prose :global(h2) {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: var(--foreground);
    line-height: 1.3;
  }

  .prose :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--foreground);
    line-height: 1.4;
  }

  .prose :global(h4) {
    font-size: 1.125rem;
    font-weight: 600;
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
    color: var(--foreground);
    line-height: 1.4;
  }

  /* First heading should not have top margin */
  .prose > :global(h2:first-child),
  .prose > :global(h3:first-child),
  .prose > :global(h4:first-child) {
    margin-top: 0;
  }

  /* Paragraphs */
  .prose :global(p) {
    margin-top: 0;
    margin-bottom: 1rem;
  }

  /* Lists */
  .prose :global(ul),
  .prose :global(ol) {
    margin-top: 0;
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .prose :global(ul) {
    list-style-type: disc;
  }

  .prose :global(ol) {
    list-style-type: decimal;
  }

  .prose :global(li) {
    margin-top: 0.25rem;
    margin-bottom: 0.25rem;
  }

  .prose :global(li > ul),
  .prose :global(li > ol) {
    margin-top: 0.25rem;
    margin-bottom: 0.25rem;
  }

  /* Links */
  .prose :global(a) {
    color: var(--primary);
    text-decoration: underline;
    text-decoration-skip-ink: all;
    text-underline-offset: 0.125em;
  }

  /* Tables */
  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
  }

  .prose :global(thead) {
    border-bottom: 2px solid var(--border);
  }

  .prose :global(th) {
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--foreground);
    background-color: var(--muted);
  }

  .prose :global(td) {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
  }

  /* Code blocks */
  .prose :global(pre) {
    background-color: var(--muted);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    margin-top: 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .prose :global(pre code) {
    background: none;
    padding: 0;
    font-size: inherit;
    color: inherit;
    border-radius: 0;
  }

  /* Inline code */
  .prose :global(code) {
    background-color: var(--muted);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  /* Blockquotes */
  .prose :global(blockquote) {
    border-left: 4px solid var(--border);
    padding-left: 1rem;
    margin-left: 0;
    margin-right: 0;
    margin-top: 1rem;
    margin-bottom: 1rem;
    color: var(--muted-foreground);
    font-style: italic;
  }

  .prose :global(blockquote p) {
    margin-bottom: 0;
  }

  /* Horizontal rule */
  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--border);
    margin: 2rem 0;
  }

  /* Strong and emphasis */
  .prose :global(strong) {
    font-weight: 600;
    color: var(--foreground);
  }

  .prose :global(em) {
    font-style: italic;
  }

  /* Images */
  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  /* Dark mode adjustments */
  :global(.dark) .prose :global(th) {
    background-color: oklch(1 0 0 / 10%);
  }

  /* Collapsible code blocks */
  .prose :global(.code-block-wrapper) {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid var(--border);
    margin-top: 1rem;
    margin-bottom: 1.5rem;
  }

  .prose :global(.code-block-wrapper pre) {
    margin: 0;
    border-radius: 0;
    border: none;
  }

  .prose :global(.code-block-wrapper.collapsed .code-content) {
    max-height: calc(1.5rem * var(--collapsed-lines, 5) + 2rem);
    overflow: hidden;
  }

  .prose :global(.code-block-wrapper.collapsed .code-content::after) {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3rem;
    background: linear-gradient(to bottom, transparent, #24292e);
    pointer-events: none;
  }

  .prose :global(.code-content) {
    position: relative;
  }

  .prose :global(.code-toggle) {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem;
    background-color: #1f2937;
    border: none;
    border-top: 1px solid #374151;
    color: #9ca3af;
    font-size: 0.875rem;
    cursor: pointer;
    transition:
      color 0.2s,
      background-color 0.2s;
  }

  .prose :global(.code-toggle:hover) {
    background-color: #374151;
    color: #f3f4f6;
  }

  .prose :global(.code-toggle:focus-visible) {
    outline: 2px solid var(--ring);
    outline-offset: -2px;
  }

  .prose :global(.code-toggle-icon) {
    transition: transform 0.2s;
  }

  .prose :global(.code-toggle[aria-expanded='true'] .code-toggle-icon) {
    transform: rotate(180deg);
  }
</style>

<script>
  function initProseCodeBlocks() {
    document.querySelectorAll('.prose').forEach((prose) => {
      const collapsedLines = parseInt(prose.getAttribute('data-collapsed-lines') || '5', 10);

      prose.querySelectorAll('pre').forEach((pre) => {
        // Skip if already wrapped
        if (pre.closest('.code-block-wrapper')) return;

        const code = pre.querySelector('code');
        if (!code) return;

        const lines = code.textContent?.split('\n').length || 0;
        if (lines <= collapsedLines) return;

        // Create wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper collapsed';
        wrapper.style.setProperty('--collapsed-lines', String(collapsedLines));

        // Create content container
        const content = document.createElement('div');
        content.className = 'code-content';

        // Create toggle button
        const blockId = `prose-code-${Math.random().toString(36).substring(2, 9)}`;
        content.id = blockId;

        const toggle = document.createElement('button');
        toggle.className = 'code-toggle';
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-controls', blockId);
        toggle.innerHTML = `
          <svg class="code-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
          <span class="code-toggle-text">Show more (${lines} lines)</span>
        `;

        toggle.addEventListener('click', () => {
          const isExpanded = wrapper.classList.contains('collapsed');
          wrapper.classList.toggle('collapsed');
          toggle.setAttribute('aria-expanded', String(isExpanded));
          const textEl = toggle.querySelector('.code-toggle-text');
          if (textEl) {
            textEl.textContent = isExpanded ? 'Show less' : `Show more (${lines} lines)`;
          }
        });

        // Wrap the pre element
        pre.parentNode?.insertBefore(wrapper, pre);
        content.appendChild(pre);
        wrapper.appendChild(content);
        wrapper.appendChild(toggle);
      });
    });
  }

  // Initialize on page load
  initProseCodeBlocks();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', initProseCodeBlocks);
</script>
