---
import { Collapsible, CollapsibleTrigger, CollapsibleContent } from '@/components/ui/collapsible';
import { type Framework } from '@/lib/frameworks';
import { getAvailablePatterns, getPatternById } from '@/lib/patterns';
import { withBase } from '@/lib/utils';
import ChevronDownIcon from 'lucide-static/icons/chevron-down.svg';
import {
  type Locale,
  getLocaleFromUrl,
  getLocalizedPath,
  useTranslation,
  getPatternName,
} from '@/i18n';

interface Props {
  pattern: string;
  framework: Framework;
  locale?: Locale;
}

const { pattern, framework } = Astro.props;
const locale = Astro.props.locale ?? getLocaleFromUrl(Astro.url);
const t = useTranslation(locale);

const availablePatterns = getAvailablePatterns();
const currentPattern = getPatternById(pattern);
---

<nav aria-label="Breadcrumb" class="mb-6 text-sm">
  <ol class="flex items-center">
    <li class="relative">
      <Collapsible class="inline-block">
        <CollapsibleTrigger
          class="text-primary focus-visible:ring-ring inline-flex items-center gap-1 rounded-sm hover:underline focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none"
          showChevron={false}
        >
          <span>{t('patterns.title')}</span>
          <ChevronDownIcon
            class="size-4 translate-y-px transition-transform duration-200 group-open/collapsible:rotate-180"
          />
        </CollapsibleTrigger>
        <CollapsibleContent
          class="border-border bg-background absolute left-0 z-10 mt-2 max-h-80 w-56 overflow-y-auto rounded-lg border shadow-lg"
        >
          <a
            href={withBase(getLocalizedPath('/patterns/', locale))}
            class="hover:bg-muted/50 focus:bg-muted focus:ring-primary flex items-center gap-2 rounded-t-lg px-4 py-2 text-sm transition-colors focus:ring-2 focus:outline-none focus:ring-inset"
          >
            <span class="inline-flex w-5 justify-center text-base" aria-hidden="true">ðŸ“š</span>
            <span>{t('patterns.available')}</span>
          </a>
          <hr class="border-border" />
          <ul class="py-1">
            {
              availablePatterns.map((p) => (
                <li>
                  <a
                    href={withBase(getLocalizedPath(`/patterns/${p.id}/${framework}/`, locale))}
                    class:list={[
                      'hover:bg-muted/50 focus:bg-muted focus:ring-primary flex items-center gap-2 px-4 py-2 text-sm transition-colors focus:ring-2 focus:outline-none focus:ring-inset',
                      pattern === p.id && 'bg-muted font-medium',
                    ]}
                    aria-current={pattern === p.id ? 'page' : undefined}
                  >
                    <span class="inline-flex w-5 justify-center text-base" aria-hidden="true">
                      {p.icon}
                    </span>
                    <span>{getPatternName(p.id, p.name, locale)}</span>
                  </a>
                </li>
              ))
            }
          </ul>
        </CollapsibleContent>
      </Collapsible>
    </li>
    <li aria-hidden="true" class="text-muted-foreground mx-2">/</li>
    <li aria-current="page">
      {currentPattern ? getPatternName(currentPattern.id, currentPattern.name, locale) : ''}
    </li>
  </ol>
</nav>

<script>
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    const details = document.querySelectorAll('nav[aria-label="Breadcrumb"] details[open]');
    details.forEach((detail) => {
      if (!detail.contains(e.target as Node)) {
        detail.removeAttribute('open');
      }
    });
  });

  // Keyboard navigation for dropdown
  document.addEventListener('keydown', (e) => {
    const openDetails = document.querySelector('nav[aria-label="Breadcrumb"] details[open]');

    // Close dropdown when pressing Escape
    if (e.key === 'Escape' && openDetails) {
      openDetails.removeAttribute('open');
      const summary = openDetails.querySelector('summary');
      summary?.focus();
      return;
    }

    // Arrow key navigation within dropdown
    if ((e.key === 'ArrowDown' || e.key === 'ArrowUp') && openDetails) {
      const links = Array.from(openDetails.querySelectorAll<HTMLAnchorElement>('a'));
      if (links.length === 0) return;

      const currentIndex = links.findIndex((link) => link === document.activeElement);

      let nextIndex: number;
      if (e.key === 'ArrowDown') {
        nextIndex = currentIndex < 0 ? 0 : (currentIndex + 1) % links.length;
      } else {
        nextIndex =
          currentIndex < 0 ? links.length - 1 : (currentIndex - 1 + links.length) % links.length;
      }

      links[nextIndex]?.focus();
      e.preventDefault();
    }
  });
</script>
