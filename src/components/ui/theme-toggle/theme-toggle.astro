---
import { cn } from '@/lib/utils';
import { Icon } from '@/components/ui/icon';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div
  data-slot="theme-toggle"
  role="radiogroup"
  aria-label="Theme"
  class={cn(
    'inline-flex h-8 items-center rounded-md border border-input bg-muted p-0.5',
    className
  )}
>
  <button
    type="button"
    role="radio"
    data-theme-value="light"
    aria-checked="true"
    tabindex="0"
    class="theme-toggle-button aria-checked:bg-background aria-checked:text-foreground text-muted-foreground hover:text-foreground inline-flex items-center gap-1.5 rounded-sm px-2 py-1 text-sm font-medium transition-colors aria-checked:shadow-sm"
  >
    <Icon name="sun" class="size-4" />
    <span>Light</span>
  </button>
  <button
    type="button"
    role="radio"
    data-theme-value="dark"
    aria-checked="false"
    tabindex="-1"
    class="theme-toggle-button aria-checked:bg-background aria-checked:text-foreground text-muted-foreground hover:text-foreground inline-flex items-center gap-1.5 rounded-sm px-2 py-1 text-sm font-medium transition-colors aria-checked:shadow-sm"
  >
    <Icon name="moon" class="size-4" />
    <span>Dark</span>
  </button>
</div>

<style>
  :global(html.no-transitions *) {
    @apply !transition-none !duration-0;
  }

  /* Active theme icon color - yellow/gold for visibility */
  .theme-toggle-button[aria-checked='true'] :global(svg) {
    color: oklch(0.8 0.18 90);
  }

  /* Focus style - inset ring to avoid overlapping with container border */
  .theme-toggle-button:focus-visible {
    outline: none;
    box-shadow: inset 0 0 0 2px var(--foreground);
  }

  /* Forced colors mode support */
  @media (forced-colors: active) {
    .theme-toggle-button[aria-checked='true'] {
      outline: 2px solid SelectedItem;
      outline-offset: -2px;
    }

    .theme-toggle-button:focus-visible {
      outline: 2px solid Highlight;
      outline-offset: -2px;
      box-shadow: none;
    }
  }
</style>

<script is:inline>
  if (!window.__themeHandlersInitialized) {
    window.__themeHandlersInitialized = true;

    /**
     * Update theme button states and roving tabindex
     * @param {string} theme - 'light' or 'dark'
     */
    function updateThemeButtons(theme) {
      document.querySelectorAll('[role="radiogroup"][aria-label="Theme"]').forEach((group) => {
        const buttons = group.querySelectorAll('.theme-toggle-button');
        buttons.forEach((btn) => {
          const isChecked = btn.getAttribute('data-theme-value') === theme;
          btn.setAttribute('aria-checked', isChecked ? 'true' : 'false');
          btn.setAttribute('tabindex', isChecked ? '0' : '-1');
        });
      });
    }

    /**
     * Apply theme to the document
     * @param {string} newTheme - 'light' or 'dark'
     */
    function applyTheme(newTheme) {
      const element = document.documentElement;

      element.classList.add('no-transitions');

      if (newTheme === 'dark') {
        element.classList.add('dark');
      } else {
        element.classList.remove('dark');
      }

      localStorage.setItem('theme', newTheme);
      element.setAttribute('data-theme', newTheme);
      updateThemeButtons(newTheme);

      requestAnimationFrame(() => {
        element.classList.remove('no-transitions');
      });
    }

    /**
     * Select a radio button and apply theme
     * @param {HTMLElement} button - The button to select
     */
    function selectRadio(button) {
      const newTheme = button.getAttribute('data-theme-value');
      applyTheme(newTheme);
      button.focus();
    }

    /**
     * Get sibling radio buttons in the same radiogroup
     * @param {HTMLElement} button - Current button
     * @returns {HTMLElement[]} Array of radio buttons
     */
    function getRadioButtons(button) {
      const group = button.closest('[role="radiogroup"]');
      if (!group) return [button];
      return Array.from(group.querySelectorAll('.theme-toggle-button'));
    }

    /**
     * Move focus and selection to adjacent radio
     * @param {HTMLElement} currentButton - Currently focused button
     * @param {number} direction - 1 for next, -1 for previous
     */
    function moveToRadio(currentButton, direction) {
      const buttons = getRadioButtons(currentButton);
      const currentIndex = buttons.indexOf(currentButton);
      const nextIndex = (currentIndex + direction + buttons.length) % buttons.length;
      selectRadio(buttons[nextIndex]);
    }

    // Initialize button states based on current theme
    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    updateThemeButtons(currentTheme);

    // Click handler - event delegation
    document.addEventListener('click', (e) => {
      const button = e.target.closest('.theme-toggle-button');
      if (!button) return;
      selectRadio(button);
    });

    // Keyboard handler - event delegation for radiogroup pattern
    document.addEventListener('keydown', (e) => {
      const button = e.target.closest('.theme-toggle-button');
      if (!button) return;

      switch (e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          e.preventDefault();
          moveToRadio(button, 1);
          break;
        case 'ArrowLeft':
        case 'ArrowUp':
          e.preventDefault();
          moveToRadio(button, -1);
          break;
        case ' ':
          e.preventDefault();
          selectRadio(button);
          break;
      }
    });

    // Update button states when sheet opens (MutationObserver for dynamic content)
    const observer = new MutationObserver(() => {
      const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      updateThemeButtons(currentTheme);
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>
