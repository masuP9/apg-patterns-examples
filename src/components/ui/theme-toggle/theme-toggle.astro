---
import { cn } from '@/lib/utils';
import { Icon } from '@/components/ui/icon';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;

const containerStyles = cn(
  // Layout
  'inline-flex h-9 items-center',
  // Border
  'rounded-md border border-input',
  // Background
  'bg-muted p-0.5'
);

const buttonStyles = cn(
  // Identifier
  'theme-toggle-button',
  'group',
  // Layout
  'inline-flex items-center gap-1.5',
  'rounded-sm py-1 pr-3 pl-2',
  // Typography
  'text-sm font-medium',
  // Default state
  'text-muted-foreground',
  // Transitions
  'transition-colors',
  // Checked state
  'aria-checked:bg-background',
  'aria-checked:shadow-sm',
  // Focus state
  'focus-visible:outline-none',
  'focus-visible:ring-2',
  'focus-visible:ring-offset-2',
  'focus-visible:ring-foreground',
  // Forced colors: checked state
  'forced-colors:aria-checked:outline-2',
  'forced-colors:aria-checked:outline-[SelectedItem]',
  'forced-colors:aria-checked:-outline-offset-2',
  // Forced colors: focus state
  'forced-colors:focus-visible:outline-2',
  'forced-colors:focus-visible:outline-[Highlight]',
  'forced-colors:focus-visible:-outline-offset-2',
  'forced-colors:focus-visible:ring-0'
);
---

<div
  data-slot="theme-toggle"
  role="radiogroup"
  aria-label="Theme"
  class={cn(containerStyles, className)}
>
  <button
    type="button"
    role="radio"
    data-theme-value="light"
    aria-checked="true"
    tabindex="0"
    class={buttonStyles}
  >
    <Icon name="sun" class="size-4 group-aria-checked:[color:oklch(0.8_0.18_90)]" />
    <span>Light</span>
  </button>
  <button
    type="button"
    role="radio"
    data-theme-value="dark"
    aria-checked="false"
    tabindex="-1"
    class={buttonStyles}
  >
    <Icon name="moon" class="size-4 group-aria-checked:[color:oklch(0.8_0.18_90)]" />
    <span>Dark</span>
  </button>
</div>

<script is:inline>
  if (!window.__themeHandlersInitialized) {
    window.__themeHandlersInitialized = true;

    /**
     * Update theme button states and roving tabindex
     * @param {string} theme - 'light' or 'dark'
     */
    function updateThemeButtons(theme) {
      document.querySelectorAll('[role="radiogroup"][aria-label="Theme"]').forEach((group) => {
        const buttons = group.querySelectorAll('.theme-toggle-button');
        buttons.forEach((btn) => {
          const isChecked = btn.getAttribute('data-theme-value') === theme;
          btn.setAttribute('aria-checked', isChecked ? 'true' : 'false');
          btn.setAttribute('tabindex', isChecked ? '0' : '-1');
        });
      });
    }

    /**
     * Apply theme to the document
     * @param {string} newTheme - 'light' or 'dark'
     */
    function applyTheme(newTheme) {
      const element = document.documentElement;

      element.classList.add('no-transitions');

      if (newTheme === 'dark') {
        element.classList.add('dark');
      } else {
        element.classList.remove('dark');
      }

      localStorage.setItem('theme', newTheme);
      element.setAttribute('data-theme', newTheme);
      updateThemeButtons(newTheme);

      requestAnimationFrame(() => {
        element.classList.remove('no-transitions');
      });
    }

    /**
     * Select a radio button and apply theme
     * @param {HTMLElement} button - The button to select
     */
    function selectRadio(button) {
      const newTheme = button.getAttribute('data-theme-value');
      applyTheme(newTheme);
      button.focus();
    }

    /**
     * Get sibling radio buttons in the same radiogroup
     * @param {HTMLElement} button - Current button
     * @returns {HTMLElement[]} Array of radio buttons
     */
    function getRadioButtons(button) {
      const group = button.closest('[role="radiogroup"]');
      if (!group) return [button];
      return Array.from(group.querySelectorAll('.theme-toggle-button'));
    }

    /**
     * Move focus and selection to adjacent radio
     * @param {HTMLElement} currentButton - Currently focused button
     * @param {number} direction - 1 for next, -1 for previous
     */
    function moveToRadio(currentButton, direction) {
      const buttons = getRadioButtons(currentButton);
      const currentIndex = buttons.indexOf(currentButton);
      const nextIndex = (currentIndex + direction + buttons.length) % buttons.length;
      selectRadio(buttons[nextIndex]);
    }

    // Initialize button states based on current theme
    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    updateThemeButtons(currentTheme);

    // Click handler - event delegation
    document.addEventListener('click', (e) => {
      const button = e.target.closest('.theme-toggle-button');
      if (!button) return;
      selectRadio(button);
    });

    // Keyboard handler - event delegation for radiogroup pattern
    document.addEventListener('keydown', (e) => {
      const button = e.target.closest('.theme-toggle-button');
      if (!button) return;

      switch (e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          e.preventDefault();
          moveToRadio(button, 1);
          break;
        case 'ArrowLeft':
        case 'ArrowUp':
          e.preventDefault();
          moveToRadio(button, -1);
          break;
        case ' ':
          e.preventDefault();
          selectRadio(button);
          break;
      }
    });

    // Update button states when sheet opens (MutationObserver for dynamic content)
    const observer = new MutationObserver(() => {
      const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      updateThemeButtons(currentTheme);
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>
