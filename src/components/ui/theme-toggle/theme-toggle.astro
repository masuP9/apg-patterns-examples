---
import { cn } from '@/lib/utils';
import { Icon } from '@/components/ui/icon';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div
  data-slot="theme-toggle"
  role="group"
  aria-label="Theme"
  class={cn(
    'inline-flex h-8 items-center rounded-md border border-input bg-muted p-0.5',
    className
  )}
>
  <button
    type="button"
    data-theme-value="light"
    aria-selected="true"
    class="theme-toggle-button aria-selected:bg-background aria-selected:text-foreground text-muted-foreground hover:text-foreground inline-flex items-center gap-1.5 rounded-sm px-2 py-1 text-sm font-medium transition-colors aria-selected:shadow-sm"
  >
    <Icon name="sun" class="size-4" />
    <span>Light</span>
  </button>
  <button
    type="button"
    data-theme-value="dark"
    aria-selected="false"
    class="theme-toggle-button aria-selected:bg-background aria-selected:text-foreground text-muted-foreground hover:text-foreground inline-flex items-center gap-1.5 rounded-sm px-2 py-1 text-sm font-medium transition-colors aria-selected:shadow-sm"
  >
    <Icon name="moon" class="size-4" />
    <span>Dark</span>
  </button>
</div>

<style>
  :global(html.no-transitions *) {
    @apply !transition-none !duration-0;
  }

  /* Active theme icon color - yellow/gold for visibility */
  .theme-toggle-button[aria-selected='true'] :global(svg) {
    color: oklch(0.8 0.18 90);
  }

  /* Forced colors mode support - use outline for selected state visibility */
  @media (forced-colors: active) {
    .theme-toggle-button[aria-selected='true'] {
      outline: 2px solid SelectedItem;
      outline-offset: -2px;
    }
  }
</style>

<script is:inline>
  if (!window.__themeHandlersInitialized) {
    window.__themeHandlersInitialized = true;

    function updateThemeButtons(theme) {
      document.querySelectorAll('.theme-toggle-button').forEach((btn) => {
        const isSelected = btn.getAttribute('data-theme-value') === theme;
        btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
      });
    }

    // Initialize button states based on current theme
    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    updateThemeButtons(currentTheme);

    // Use event delegation for dynamically added buttons (e.g., in mobile menu)
    document.addEventListener('click', (e) => {
      const button = e.target.closest('.theme-toggle-button');
      if (!button) return;

      const newTheme = button.getAttribute('data-theme-value');
      const element = document.documentElement;

      element.classList.add('no-transitions');

      if (newTheme === 'dark') {
        element.classList.add('dark');
      } else {
        element.classList.remove('dark');
      }

      localStorage.setItem('theme', newTheme);
      element.setAttribute('data-theme', newTheme);
      updateThemeButtons(newTheme);

      requestAnimationFrame(() => {
        element.classList.remove('no-transitions');
      });
    });

    // Update button states when sheet opens (MutationObserver for dynamic content)
    const observer = new MutationObserver(() => {
      const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      updateThemeButtons(currentTheme);
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>
