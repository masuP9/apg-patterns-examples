---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import CodeBlock from '@/components/ui/CodeBlock.astro';
import fs from 'node:fs';
import path from 'node:path';

// Read actual test file at build time
const e2eTestPath = path.join(process.cwd(), 'e2e/accordion.spec.ts');
const e2eTestCode = fs.readFileSync(e2eTestPath, 'utf-8');
---

<div class="prose dark:prose-invert max-w-none">
  <p class="text-muted-foreground mb-4">
    テストは、キーボード操作、ARIA属性、アクセシビリティ要件におけるAPG準拠を検証します。Accordion
    コンポーネントは2層のテスト戦略を使用しています。
  </p>

  <h3 class="mb-3 text-lg font-medium">テスト戦略</h3>

  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <h4 class="mb-2 font-medium">ユニットテスト (Testing Library)</h4>
    <p class="text-muted-foreground mb-2 text-sm">
      フレームワーク固有のテストライブラリを使用して、コンポーネントの出力を検証します。これらのテストは正しいHTML構造とARIA属性を確保します。
    </p>
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      <li>ARIA 属性 (aria-expanded, aria-controls, aria-labelledby)</li>
      <li>キーボード操作 (Enter, Space, 矢印キー)</li>
      <li>展開/折り畳み動作</li>
      <li>jest-axe によるアクセシビリティ</li>
    </ul>
  </div>

  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <h4 class="mb-2 font-medium">E2E テスト (Playwright)</h4>
    <p class="text-muted-foreground mb-2 text-sm">
      実際のブラウザ環境でコンポーネントの動作を全フレームワークにわたって検証します。これらのテストはインタラクションとクロスフレームワークの一貫性をカバーします。
    </p>
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      <li>クリック操作</li>
      <li>矢印キーナビゲーション</li>
      <li>Home/End キーナビゲーション</li>
      <li>ライブブラウザでの ARIA 構造検証</li>
      <li>axe-core アクセシビリティスキャン</li>
      <li>クロスフレームワーク一貫性チェック</li>
    </ul>
  </div>

  <h3 class="mb-3 text-lg font-medium">テストカテゴリ</h3>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: APG キーボード操作 (Unit + E2E)
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Enter キー</code></td>
          <td class="py-2">フォーカスされたパネルを展開/折り畳み</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Space キー</code></td>
          <td class="py-2">フォーカスされたパネルを展開/折り畳み</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>ArrowDown</code></td>
          <td class="py-2">次のヘッダーにフォーカスを移動</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>ArrowUp</code></td>
          <td class="py-2">前のヘッダーにフォーカスを移動</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Home</code></td>
          <td class="py-2">最初のヘッダーにフォーカスを移動</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>End</code></td>
          <td class="py-2">最後のヘッダーにフォーカスを移動</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>ループなし</code></td>
          <td class="py-2">フォーカスは端で停止 (ループしない)</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>無効化スキップ</code></td>
          <td class="py-2">ナビゲーション中に無効化されたヘッダーをスキップ</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: APG ARIA 属性 (Unit + E2E)
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-expanded</code></td>
          <td class="py-2">ヘッダーボタンが展開/折り畳み状態を反映</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-controls</code></td>
          <td class="py-2">ヘッダーが aria-controls でパネルを参照</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-labelledby</code></td>
          <td class="py-2">パネルが aria-labelledby でヘッダーを参照</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="region"</code></td>
          <td class="py-2">パネルに region ロール (6個以下のパネル)</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>region なし (7個以上)</code></td>
          <td class="py-2">7個以上のパネルの場合、region ロールを省略</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-disabled</code></td>
          <td class="py-2">無効化された項目に aria-disabled="true"</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: クリック操作 (Unit + E2E)
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>クリックで展開</code></td>
          <td class="py-2">ヘッダーをクリックするとパネルが展開</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>クリックで折り畳み</code></td>
          <td class="py-2">展開されたヘッダーをクリックするとパネルが折り畳み</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>単一展開</code></td>
          <td class="py-2">パネルを開くと他のパネルが閉じる（デフォルト）</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>複数展開</code></td>
          <td class="py-2">allowMultiple で複数のパネルを開ける</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: 見出し構造 (Unit + E2E)
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>headingLevel プロパティ</code></td>
          <td class="py-2">正しい見出し要素を使用 (h2, h3, など)</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
    中優先度: 無効状態 (Unit + E2E)
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>無効でクリック不可</code></td>
          <td class="py-2">無効化されたヘッダーをクリックしても展開しない</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>無効でキーボード不可</code></td>
          <td class="py-2">Enter/Space で無効化されたヘッダーが動作しない</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
    中優先度: アクセシビリティ (Unit + E2E)
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>axe 違反</code></td>
          <td class="py-2">WCAG 2.1 AA 違反なし (jest-axe/axe-core 経由)</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-green-500"></span>
    低優先度: クロスフレームワーク一貫性 (E2E)
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>全フレームワークでレンダリング</code></td>
          <td class="py-2">React, Vue, Svelte, Astro で全てアコーディオンがレンダリングされる</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>一貫した ARIA</code></td>
          <td class="py-2">全フレームワークで一貫した ARIA 構造</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h3 class="mb-3 text-lg font-medium">テストコード例</h3>
  <p class="text-muted-foreground mb-4 text-sm">
    以下は実際の E2E テストファイル (<code>e2e/accordion.spec.ts</code>) です。
  </p>
  <CodeBlock
    code={e2eTestCode}
    lang="typescript"
    title="e2e/accordion.spec.ts"
    collapsible
    collapsedLines={20}
  />

  <h3 class="mb-3 text-lg font-medium">テストの実行</h3>
  <pre
    class="overflow-x-auto rounded-lg bg-gray-100 p-4 text-sm dark:bg-gray-800"><code># Accordion のユニットテストを実行
npm run test -- accordion

# Accordion の E2E テストを実行（全フレームワーク）
npm run test:e2e:pattern --pattern=accordion

# 特定フレームワークの E2E テストを実行
npm run test:e2e:react:pattern --pattern=accordion
npm run test:e2e:vue:pattern --pattern=accordion
npm run test:e2e:svelte:pattern --pattern=accordion
npm run test:e2e:astro:pattern --pattern=accordion</code></pre>

  <h3 class="mb-3 text-lg font-medium">テストツール</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    <li>
      <ExternalLink href="https://vitest.dev/" class="text-primary hover:underline"
        >Vitest</ExternalLink
      >
      - ユニットテスト用テストランナー
    </li>
    <li>
      <ExternalLink href="https://testing-library.com/" class="text-primary hover:underline"
        >Testing Library</ExternalLink
      >
      - フレームワーク固有のテストユーティリティ (React, Vue, Svelte)
    </li>
    <li>
      <ExternalLink href="https://playwright.dev/" class="text-primary hover:underline"
        >Playwright</ExternalLink
      >
      - E2E テスト用ブラウザ自動化
    </li>
    <li>
      <ExternalLink
        href="https://github.com/dequelabs/axe-core-npm/tree/develop/packages/playwright"
        class="text-primary hover:underline">axe-core/playwright</ExternalLink
      >
      - E2E での自動アクセシビリティテスト
    </li>
  </ul>

  <p class="text-muted-foreground text-sm">
    詳細なドキュメントは <ExternalLink
      href="https://github.com/masuP9/apg-patterns-examples/blob/main/.internal/testing-strategy.md"
      class="text-primary hover:underline">testing-strategy.md</ExternalLink
    > を参照してください。
  </p>
</div>
