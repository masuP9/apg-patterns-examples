---
/**
 * APG Alert Dialog Pattern - Astro Implementation
 *
 * A modal dialog that interrupts the user's workflow to communicate an important
 * message and require a response. Unlike regular Dialog, uses role="alertdialog"
 * which may trigger system alert sounds in assistive technologies.
 *
 * @see https://www.w3.org/WAI/ARIA/apg/patterns/alertdialog/
 */

export interface Props {
  /** Dialog title (required for accessibility) */
  title: string;
  /** Alert message (required - unlike regular Dialog) */
  message: string;
  /** Trigger button text */
  triggerText: string;
  /** Confirm button label */
  confirmLabel?: string;
  /** Cancel button label */
  cancelLabel?: string;
  /** Confirm button variant */
  confirmVariant?: 'default' | 'danger';
  /** Allow closing with Escape key (default: false - unlike regular Dialog) */
  allowEscapeClose?: boolean;
  /** Additional CSS class for trigger button */
  triggerClass?: string;
  /** Additional CSS class for dialog */
  class?: string;
}

const {
  title,
  message,
  triggerText,
  confirmLabel = 'OK',
  cancelLabel = 'Cancel',
  confirmVariant = 'default',
  allowEscapeClose = false,
  triggerClass = '',
  class: className = '',
} = Astro.props;

// Generate unique ID for this instance
const instanceId = `alert-dialog-${Math.random().toString(36).substring(2, 11)}`;
const titleId = `${instanceId}-title`;
const messageId = `${instanceId}-message`;

const confirmButtonClass =
  confirmVariant === 'danger'
    ? 'apg-alert-dialog-confirm apg-alert-dialog-confirm--danger'
    : 'apg-alert-dialog-confirm';
---

<apg-alert-dialog data-allow-escape-close={allowEscapeClose ? 'true' : 'false'}>
  <!-- Trigger Button -->
  <button
    type="button"
    class={`apg-alert-dialog-trigger ${triggerClass}`.trim()}
    data-alert-dialog-trigger
  >
    {triggerText}
  </button>

  <!-- Native Dialog Element with alertdialog role -->
  <dialog
    role="alertdialog"
    class={`apg-alert-dialog ${className}`.trim()}
    aria-labelledby={titleId}
    aria-describedby={messageId}
    data-alert-dialog-content
  >
    <h2 id={titleId} class="apg-alert-dialog-title">
      {title}
    </h2>
    <p id={messageId} class="apg-alert-dialog-message">
      {message}
    </p>
    <div class="apg-alert-dialog-actions">
      <button type="button" class="apg-alert-dialog-cancel" data-cancel>
        {cancelLabel}
      </button>
      <button type="button" class={confirmButtonClass} data-confirm>
        {confirmLabel}
      </button>
    </div>
  </dialog>
</apg-alert-dialog>

<script>
  class ApgAlertDialog extends HTMLElement {
    private trigger: HTMLButtonElement | null = null;
    private dialog: HTMLDialogElement | null = null;
    private cancelButton: HTMLButtonElement | null = null;
    private confirmButton: HTMLButtonElement | null = null;
    private allowEscapeClose = false;

    connectedCallback() {
      this.trigger = this.querySelector('[data-alert-dialog-trigger]');
      this.dialog = this.querySelector('[data-alert-dialog-content]');
      this.cancelButton = this.querySelector('[data-cancel]');
      this.confirmButton = this.querySelector('[data-confirm]');

      if (!this.trigger || !this.dialog) {
        console.warn('apg-alert-dialog: required elements not found');
        return;
      }

      this.allowEscapeClose = this.dataset.allowEscapeClose === 'true';

      // Attach event listeners
      this.trigger.addEventListener('click', this.open);
      this.cancelButton?.addEventListener('click', this.handleCancelClick);
      this.confirmButton?.addEventListener('click', this.handleConfirm);
      this.dialog.addEventListener('keydown', this.handleKeyDown, true);
      this.dialog.addEventListener('cancel', this.handleDialogCancel);
      this.dialog.addEventListener('close', this.handleClose);
    }

    disconnectedCallback() {
      this.trigger?.removeEventListener('click', this.open);
      this.cancelButton?.removeEventListener('click', this.handleCancelClick);
      this.confirmButton?.removeEventListener('click', this.handleConfirm);
      this.dialog?.removeEventListener('keydown', this.handleKeyDown, true);
      this.dialog?.removeEventListener('cancel', this.handleDialogCancel);
      this.dialog?.removeEventListener('close', this.handleClose);
    }

    private open = () => {
      if (!this.dialog) return;

      // Lock body scroll
      document.body.style.overflow = 'hidden';
      this.dialog.showModal();

      // Focus cancel button (safest action - unlike regular Dialog)
      requestAnimationFrame(() => {
        this.cancelButton?.focus();
      });

      // Dispatch custom event
      this.dispatchEvent(
        new CustomEvent('alertdialogopen', {
          bubbles: true,
        })
      );
    };

    private close = () => {
      // Unlock body scroll
      document.body.style.overflow = '';
      this.dialog?.close();
    };

    private handleClose = () => {
      // Unlock body scroll
      document.body.style.overflow = '';
      // Return focus to trigger
      this.trigger?.focus();

      // Dispatch custom event
      this.dispatchEvent(
        new CustomEvent('alertdialogclose', {
          bubbles: true,
        })
      );
    };

    private handleKeyDown = (e: KeyboardEvent) => {
      // Handle Escape key
      if (e.key === 'Escape') {
        e.preventDefault();
        e.stopPropagation();
        if (this.allowEscapeClose) {
          this.dispatchEvent(
            new CustomEvent('cancel', {
              bubbles: true,
            })
          );
          this.close();
        }
        return;
      }

      // Handle focus trap for Tab key
      if (e.key === 'Tab' && this.dialog) {
        const focusableElements = this.dialog.querySelectorAll<HTMLElement>(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.shiftKey) {
          // Shift+Tab from first element -> wrap to last
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement?.focus();
          }
        } else {
          // Tab from last element -> wrap to first
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement?.focus();
          }
        }
      }
    };

    // Handle native dialog cancel event (fired when Escape pressed in real browsers)
    private handleDialogCancel = (e: Event) => {
      if (!this.allowEscapeClose) {
        e.preventDefault();
      } else {
        this.dispatchEvent(
          new CustomEvent('cancel', {
            bubbles: true,
          })
        );
      }
    };

    private handleCancelClick = () => {
      this.dispatchEvent(
        new CustomEvent('cancel', {
          bubbles: true,
        })
      );
      this.close();
    };

    private handleConfirm = () => {
      this.dispatchEvent(
        new CustomEvent('confirm', {
          bubbles: true,
        })
      );
      this.close();
    };
  }

  // Register the custom element
  if (!customElements.get('apg-alert-dialog')) {
    customElements.define('apg-alert-dialog', ApgAlertDialog);
  }
</script>
