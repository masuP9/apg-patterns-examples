---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
---

<div class="prose dark:prose-invert max-w-none">
  <p class="text-muted-foreground mb-4">
    テストは、ライブリージョンの動作、ARIA属性、アクセシビリティ要件全体にわたってAPG準拠を検証します。
    Alertコンポーネントは2層のテスト戦略を採用しています。
  </p>

  <h3 class="mb-3 text-lg font-medium">テスト戦略</h3>

  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <h4 class="mb-2 font-medium">ユニットテスト（Testing Library）</h4>
    <p class="text-muted-foreground mb-2 text-sm">
      フレームワーク固有のテストライブラリを使用してコンポーネントのレンダリング出力を検証します。これらのテストは正しいHTML構造とARIA属性を確認します。
    </p>
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      <li>ARIA属性（role="alert"）</li>
      <li>ライブリージョンコンテナのDOM内での永続性</li>
      <li>閉じるボタンのアクセシビリティ</li>
      <li>jest-axeによるアクセシビリティ検証</li>
    </ul>
  </div>

  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <h4 class="mb-2 font-medium">E2Eテスト（Playwright）</h4>
    <p class="text-muted-foreground mb-2 text-sm">
      すべてのフレームワークで実際のブラウザ環境でコンポーネントの動作を検証します。これらのテストはインタラクションとフレームワーク間の一貫性をカバーします。
    </p>
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      <li>ライブブラウザでのARIA構造</li>
      <li>フォーカス管理（アラートはフォーカスを奪わない）</li>
      <li>閉じるボタンのキーボード操作</li>
      <li>Tabナビゲーションの動作</li>
      <li>axe-coreによるアクセシビリティスキャン</li>
      <li>フレームワーク間の一貫性チェック</li>
    </ul>
  </div>

  <h3 class="mb-3 text-lg font-medium">テストカテゴリ</h3>

  <div class="mb-6">
    <h4 class="mb-2 flex items-center gap-2 font-medium">
      <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
      高優先度: APG コア準拠（Unit + E2E）
    </h4>
    <ResponsiveTable>
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="border-border border-b">
            <th class="py-2 pr-4 text-left">テスト</th>
            <th class="py-2 text-left">APG 要件</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">role="alert" の存在</td>
            <td class="py-2">アラートコンテナは alert ロールを持つ必要がある</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">コンテナが常に DOM に存在</td>
            <td class="py-2">ライブリージョンは動的に追加・削除してはならない</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">メッセージ変更時も同じコンテナ</td>
            <td class="py-2">更新時にコンテナ要素の同一性が保持される</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">アラート後もフォーカスは変わらない</td>
            <td class="py-2">アラートはキーボードフォーカスを移動してはならない</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">アラートはフォーカス不可</td>
            <td class="py-2">アラートコンテナは tabindex を持ってはならない</td>
          </tr>
        </tbody>
      </table>
    </ResponsiveTable>
  </div>

  <div class="mb-6">
    <h4 class="mb-2 flex items-center gap-2 font-medium">
      <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
      中優先度: アクセシビリティ検証（Unit + E2E）
    </h4>
    <ResponsiveTable>
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="border-border border-b">
            <th class="py-2 pr-4 text-left">テスト</th>
            <th class="py-2 text-left">WCAG 要件</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">axe 違反なし（メッセージあり）</td>
            <td class="py-2">WCAG 2.1 AA 準拠</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">axe 違反なし（空）</td>
            <td class="py-2">WCAG 2.1 AA 準拠</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">axe 違反なし（閉じるボタンあり）</td>
            <td class="py-2">WCAG 2.1 AA 準拠</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">閉じるボタンにアクセシブルな名前</td>
            <td class="py-2">ボタンは aria-label を持つ</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">閉じるボタンは type="button"</td>
            <td class="py-2">フォーム送信を防ぐ</td>
          </tr>
        </tbody>
      </table>
    </ResponsiveTable>
  </div>

  <div class="mb-6">
    <h4 class="mb-2 flex items-center gap-2 font-medium">
      <span class="inline-block h-3 w-3 rounded-full bg-green-500"></span>
      低優先度: Props と拡張性（Unit）
    </h4>
    <ResponsiveTable>
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="border-border border-b">
            <th class="py-2 pr-4 text-left">テスト</th>
            <th class="py-2 text-left">機能</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">variant prop でスタイルを変更</td>
            <td class="py-2">ビジュアルのカスタマイズ</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">id prop でカスタム ID を設定</td>
            <td class="py-2">SSR サポート</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">className の継承</td>
            <td class="py-2">スタイルのカスタマイズ</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">複雑なコンテンツの children</td>
            <td class="py-2">コンテンツの柔軟性</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">onDismiss コールバックが発火</td>
            <td class="py-2">イベント処理</td>
          </tr>
        </tbody>
      </table>
    </ResponsiveTable>
  </div>

  <div class="mb-6">
    <h4 class="mb-2 flex items-center gap-2 font-medium">
      <span class="inline-block h-3 w-3 rounded-full bg-green-500"></span>
      低優先度: フレームワーク間の一貫性（E2E）
    </h4>
    <ResponsiveTable>
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="border-border border-b">
            <th class="py-2 pr-4 text-left">テスト</th>
            <th class="py-2 text-left">説明</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">すべてのフレームワークにアラートがある</td>
            <td class="py-2">React、Vue、Svelte、Astroすべてがアラート要素をレンダリング</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">同じトリガーボタン</td>
            <td class="py-2">すべてのフレームワークで一貫したトリガーボタン</td>
          </tr>
          <tr class="border-border border-b">
            <td class="py-2 pr-4">クリックでアラートを表示</td>
            <td class="py-2">すべてのフレームワークでボタンクリック時にアラートを表示</td>
          </tr>
        </tbody>
      </table>
    </ResponsiveTable>
  </div>

  <h3 class="mb-3 text-lg font-medium">スクリーンリーダーテスト</h3>
  <p class="text-muted-foreground mb-4">
    自動テストは DOM
    構造を検証しますが、実際のアナウンス動作を検証するにはスクリーンリーダーによる手動テストが不可欠です：
  </p>
  <ResponsiveTable>
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">スクリーンリーダー</th>
          <th class="py-2 text-left">プラットフォーム</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4">VoiceOver</td>
          <td class="py-2">macOS / iOS</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4">NVDA</td>
          <td class="py-2">Windows</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4">JAWS</td>
          <td class="py-2">Windows</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4">TalkBack</td>
          <td class="py-2">Android</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mt-2 text-sm">
    メッセージの変更が即座のアナウンスをトリガーすること、およびページ読み込み時に存在するコンテンツはアナウンスされないことを確認してください。
  </p>

  <h3 class="mt-6 mb-3 text-lg font-medium">テストツール</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    <li>
      <ExternalLink href="https://vitest.dev/" class="text-primary hover:underline"
        >Vitest</ExternalLink
      >
      - ユニットテストランナー
    </li>
    <li>
      <ExternalLink href="https://testing-library.com/" class="text-primary hover:underline"
        >Testing Library</ExternalLink
      >
      - フレームワーク別テストユーティリティ（React、Vue、Svelte）
    </li>
    <li>
      <ExternalLink href="https://playwright.dev/" class="text-primary hover:underline"
        >Playwright</ExternalLink
      >
      - E2Eテスト用ブラウザ自動化
    </li>
    <li>
      <ExternalLink
        href="https://github.com/dequelabs/axe-core-npm/tree/develop/packages/playwright"
        class="text-primary hover:underline">axe-core/playwright</ExternalLink
      >
      - E2Eでの自動アクセシビリティテスト
    </li>
  </ul>

  <h3 class="mt-6 mb-3 text-lg font-medium">テストの実行</h3>
  <pre
    class="overflow-x-auto rounded-lg bg-gray-100 p-4 text-sm dark:bg-gray-800"><code># すべての Alert テストを実行
npm run test -- alert

# 特定のフレームワークのテストを実行
npm run test -- Alert.test.tsx    # React
npm run test -- Alert.test.vue    # Vue
npm run test -- Alert.test.svelte # Svelte</code></pre>

  <p class="text-muted-foreground text-sm">
    完全なドキュメントについては<ExternalLink
      href="https://github.com/masuP9/apg-patterns-examples/blob/main/.internal/testing-strategy.md"
      class="text-primary hover:underline">testing-strategy.md</ExternalLink
    >を参照してください。
  </p>
</div>
