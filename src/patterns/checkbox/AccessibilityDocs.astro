---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import { checkboxAccessibilityData } from './accessibility-data';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;

const {
  roles,
  states,
  properties,
  keyboardSupport,
  focusManagement,
  additionalNotes,
  references,
  accessibleNaming,
  visualDesign,
} = checkboxAccessibilityData;

// Create localization function
const t = localize(locale);
const h = createTableHeaderTranslator(locale);
---

<div class="prose dark:prose-invert max-w-none">
  <h3 class="mb-3 text-lg font-medium">{h('section.ariaRoles')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.role')}</th>
          <th class="py-2 pr-4 text-left">{h('table.element')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          roles.map((role) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{role.name}</code>
              </td>
              <td
                class="py-2 pr-4"
                set:html={t(role.element).replace(/</g, '&lt;').replace(/>/g, '&gt;')}
              />
              <td
                class="py-2"
                set:html={t(role.description).replace(/</g, '&lt;').replace(/>/g, '&gt;')}
              />
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">
    {
      locale === 'ja' ? (
        <>
          この実装ではネイティブの <code>&lt;input type="checkbox"&gt;</code> を使用しており、
          <code>checkbox</code> ロールを暗黙的に提供します。<code>&lt;div&gt;</code> や{' '}
          <code>&lt;button&gt;</code> を使用したカスタム実装では、明示的に{' '}
          <code>role="checkbox"</code> が必要です。
        </>
      ) : (
        <>
          This implementation uses native <code>&lt;input type="checkbox"&gt;</code> which provides
          the <code>checkbox</code> role implicitly. For custom implementations using{' '}
          <code>&lt;div&gt;</code> or <code>&lt;button&gt;</code>, explicit{' '}
          <code>role="checkbox"</code> is required.
        </>
      )
    }
  </p>

  <h3 class="mb-3 text-lg font-medium">{h('section.ariaStates')}</h3>
  {
    states?.map((state) => (
      <div class="mb-6">
        <h4 class="mb-2 font-medium">
          <code>{state.attribute}</code>
        </h4>
        <ResponsiveTable class="mb-2">
          <table class="w-full border-collapse">
            <tbody>
              <tr class="border-border border-b">
                <td class="w-32 py-2 pr-4 font-medium">{h('table.values')}</td>
                <td class="py-2">
                  {t(state.values)
                    .split(' | ')
                    .map((v: string, i: number, arr: string[]) => (
                      <>
                        <code>{v.trim()}</code>
                        {i < arr.length - 1 && ' | '}
                      </>
                    ))}
                </td>
              </tr>
              <tr class="border-border border-b">
                <td class="py-2 pr-4 font-medium">{h('table.required')}</td>
                <td class="py-2">{state.required ? h('value.yes') : h('value.no')}</td>
              </tr>
              {state.changeTrigger && (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4 font-medium">{h('table.changeTrigger')}</td>
                  <td class="py-2">{t(state.changeTrigger)}</td>
                </tr>
              )}
              {state.reference && (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4 font-medium">{h('table.reference')}</td>
                  <td class="py-2">
                    <ExternalLink href={state.reference} class="text-primary hover:underline">
                      {state.attribute}
                    </ExternalLink>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </ResponsiveTable>
      </div>
    ))
  }

  {
    keyboardSupport && keyboardSupport.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{h('section.keyboardSupport')}</h3>
        <ResponsiveTable class="mb-4">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.key')}</th>
                <th class="py-2 text-left">{h('table.action')}</th>
              </tr>
            </thead>
            <tbody>
              {keyboardSupport.map((shortcut) => {
                const keyText = t(shortcut.key);
                return (
                  <tr class="border-border border-b">
                    <td class="py-2 pr-4">
                      {keyText.includes('+') ? (
                        <Fragment>
                          {keyText.split(/\s*\+\s*/).map((k: string, i: number, arr: string[]) => (
                            <>
                              <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                                {k.trim()}
                              </kbd>
                              {i < arr.length - 1 && ' + '}
                            </>
                          ))}
                        </Fragment>
                      ) : (
                        <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">{keyText}</kbd>
                      )}
                    </td>
                    <td class="py-2">{t(shortcut.action)}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </ResponsiveTable>
        {additionalNotes && additionalNotes.length > 0 && (
          <p class="text-muted-foreground mb-6 text-sm">
            <strong>{locale === 'ja' ? '注意:' : 'Note:'}</strong> {t(additionalNotes[0])}
          </p>
        )}
      </>
    )
  }

  {
    accessibleNaming && (
      <>
        <h3 class="mb-3 text-lg font-medium">
          {accessibleNaming.title ? t(accessibleNaming.title) : ''}
        </h3>
        <p class="text-muted-foreground mb-3">
          {accessibleNaming.description ? t(accessibleNaming.description) : ''}
        </p>
        <ul class="mb-6 list-disc space-y-2 pl-6">
          {accessibleNaming.methods?.map((method) => (
            <li>
              <strong>{t(method.method)}</strong>
              {method.description && <> - {t(method.description)}</>}
            </li>
          ))}
        </ul>
      </>
    )
  }

  {
    visualDesign && !Array.isArray(visualDesign) && (
      <>
        <h3 class="mb-3 text-lg font-medium">{visualDesign.title ? t(visualDesign.title) : ''}</h3>
        <p class="text-muted-foreground mb-3">
          {visualDesign.description ? t(visualDesign.description) : ''}
        </p>
        <ul class="mb-6 list-disc space-y-2 pl-6">
          {visualDesign.stateIndicators?.map((indicator) => (
            <li>
              <strong>{t(indicator.state)}</strong> - {t(indicator.indicator)}
            </li>
          ))}
        </ul>
      </>
    )
  }

  <h3 class="mb-3 text-lg font-medium">{locale === 'ja' ? '参考資料' : 'References'}</h3>
  <ul class="list-disc space-y-2 pl-6">
    {
      references?.map((ref) => (
        <li>
          <ExternalLink href={ref.url} class="text-primary hover:underline">
            {ref.title}
          </ExternalLink>
        </li>
      ))
    }
  </ul>
</div>
