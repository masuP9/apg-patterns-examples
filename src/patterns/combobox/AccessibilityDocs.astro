---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import type { Locale } from '@/i18n';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import { comboboxAccessibilityData } from './accessibility-data';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;
const t = localize(locale);
const h = createTableHeaderTranslator(locale);
const data = comboboxAccessibilityData;

// Group keyboard support by section
const keyboardBySection = (data.keyboardSupport || []).reduce(
  (acc, key) => {
    const section = t(key.section || '');
    if (!acc[section]) acc[section] = [];
    acc[section].push(key);
    return acc;
  },
  {} as Record<string, typeof data.keyboardSupport>
);

// Autocomplete modes
const autocompleteModes = [
  {
    mode: 'list',
    behavior: {
      en: 'Options are filtered based on input value (default)',
      ja: 'オプションは入力値に基づいてフィルタリングされる（デフォルト）',
    },
  },
  {
    mode: 'none',
    behavior: {
      en: 'All options shown regardless of input value',
      ja: '入力値に関係なくすべてのオプションを表示',
    },
  },
  {
    mode: 'both',
    behavior: {
      en: 'Options filtered and first match auto-completed in input',
      ja: 'オプションをフィルタリングし、最初の一致を入力にオートコンプリート',
    },
  },
];

// Translations
const labels = {
  ariaPropertiesInput:
    locale === 'ja' ? 'WAI-ARIA プロパティ（Input）' : 'WAI-ARIA Properties (Input)',
  ariaPropertiesListbox:
    locale === 'ja'
      ? 'WAI-ARIA プロパティ（Listbox & Options）'
      : 'WAI-ARIA Properties (Listbox & Options)',
  autocompleteModes: locale === 'ja' ? 'オートコンプリートモード' : 'Autocomplete Modes',
  hiddenState: locale === 'ja' ? '非表示状態' : 'Hidden State',
  mode: locale === 'ja' ? 'モード' : 'Mode',
  behavior: locale === 'ja' ? '動作' : 'Behavior',
  target: locale === 'ja' ? '対象' : 'Target',
  hiddenDescription:
    locale === 'ja'
      ? '閉じている時、リストボックスは <code>hidden</code> 属性を使用して：'
      : 'When closed, the listbox uses the <code>hidden</code> attribute to:',
  hiddenPoints:
    locale === 'ja'
      ? [
          'ポップアップを視覚的に非表示にする',
          'ポップアップをアクセシビリティツリーから削除する',
          'リストボックス要素は DOM に残り、<code>aria-controls</code> の参照が有効なまま',
        ]
      : [
          'Hide the popup from visual display',
          'Remove the popup from the accessibility tree',
          'The listbox element remains in the DOM so <code>aria-controls</code> reference is valid',
        ],
};

// Split properties into input vs listbox/options
const inputProperties = (data.properties || []).filter(
  (p) => p.element === 'input' || p.attribute === 'role="combobox"'
);
const listboxProperties = (data.properties || []).filter(
  (p) => p.element === 'option' || p.element === 'listbox' || typeof p.element === 'object'
);
---

<div class="prose dark:prose-invert max-w-none">
  <h3 class="mb-3 text-lg font-medium">{h('section.ariaRoles')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.role')}</th>
          <th class="py-2 pr-4 text-left">{h('table.element')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          data.roles.map((role) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{role.name}</code>
              </td>
              <td class="py-2 pr-4">{t(role.element)}</td>
              <td class="py-2">{t(role.description)}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">
    <ExternalLink href="https://w3c.github.io/aria/#combobox" class="text-primary hover:underline">
      WAI-ARIA combobox role
    </ExternalLink>
  </p>

  <h3 class="mb-3 text-lg font-medium">{labels.ariaPropertiesInput}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
          <th class="py-2 pr-4 text-left">{h('table.values')}</th>
          <th class="py-2 pr-4 text-left">{h('table.required')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          inputProperties.map((prop) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{prop.attribute}</code>
              </td>
              <td class="py-2 pr-4">{prop.values}</td>
              <td class="py-2 pr-4">
                {typeof prop.required === 'boolean'
                  ? prop.required
                    ? locale === 'ja'
                      ? 'はい'
                      : 'Yes'
                    : locale === 'ja'
                      ? 'いいえ'
                      : 'No'
                  : t(prop.required)}
              </td>
              <td class="py-2">{t(prop.notes || '')}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>

  <h3 class="mb-3 text-lg font-medium">{labels.ariaPropertiesListbox}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
          <th class="py-2 pr-4 text-left">{labels.target}</th>
          <th class="py-2 pr-4 text-left">{h('table.values')}</th>
          <th class="py-2 pr-4 text-left">{h('table.required')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          listboxProperties.map((prop) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{prop.attribute}</code>
              </td>
              <td class="py-2 pr-4">{t(prop.element)}</td>
              <td class="py-2 pr-4">{prop.values}</td>
              <td class="py-2 pr-4">
                {typeof prop.required === 'boolean'
                  ? prop.required
                    ? locale === 'ja'
                      ? 'はい'
                      : 'Yes'
                    : locale === 'ja'
                      ? 'いいえ'
                      : 'No'
                  : t(prop.required)}
              </td>
              <td class="py-2">{t(prop.notes || '')}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>

  <h3 class="mb-3 text-lg font-medium">{h('section.keyboardSupport')}</h3>
  {
    Object.entries(keyboardBySection).map(([section, keys]) => (
      <>
        <h4 class="mb-2 font-medium">{section}</h4>
        <ResponsiveTable class="mb-4">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.key')}</th>
                <th class="py-2 text-left">{h('table.action')}</th>
              </tr>
            </thead>
            <tbody>
              {keys?.map((key) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    {typeof key.key === 'string' ? (
                      <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">{key.key}</kbd>
                    ) : (
                      t(key.key)
                    )}
                  </td>
                  <td class="py-2">{t(key.action)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.focusManagement')}</h3>
  <p class="text-muted-foreground mb-4">
    {
      locale === 'ja'
        ? 'このコンポーネントは仮想フォーカス管理に aria-activedescendant を使用します：'
        : 'This component uses aria-activedescendant for virtual focus management:'
    }
  </p>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    {data.focusManagement?.map((rule) => <li>{t(rule.behavior)}</li>)}
  </ul>

  <h3 class="mb-3 text-lg font-medium">{labels.autocompleteModes}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{labels.mode}</th>
          <th class="py-2 text-left">{labels.behavior}</th>
        </tr>
      </thead>
      <tbody>
        {
          autocompleteModes.map((mode) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{mode.mode}</code>
              </td>
              <td class="py-2">{mode.behavior[locale]}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>

  <h3 class="mb-3 text-lg font-medium">{labels.hiddenState}</h3>
  <p class="text-muted-foreground mb-4"><Fragment set:html={labels.hiddenDescription} /></p>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    {
      labels.hiddenPoints.map((point) => (
        <li>
          <Fragment set:html={point} />
        </li>
      ))
    }
  </ul>
</div>
