---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import { feedAccessibilityData } from './accessibility-data';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;

const {
  roles,
  properties,
  states,
  keyboardSupport,
  focusManagement,
  additionalNotes,
  references,
  structureNote,
  keyboardDocNote,
} = feedAccessibilityData;

// Create localization function
const t = localize(locale);
const h = createTableHeaderTranslator(locale);
---

<div class="prose dark:prose-invert max-w-none">
  <h3 class="mb-3 text-lg font-medium">{h('section.ariaRoles')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.role')}</th>
          <th class="py-2 pr-4 text-left">{h('table.element')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          roles.map((role) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{role.name}</code>
              </td>
              <td class="py-2 pr-4">{t(role.element)}</td>
              <td class="py-2">{t(role.description)}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  {
    references && references.length > 0 && (
      <p class="text-muted-foreground mb-6 text-sm">
        <ExternalLink href={references[0].url} class="text-primary hover:underline">
          {references[0].title}
        </ExternalLink>
      </p>
    )
  }

  {
    structureNote && (
      <div
        class="border-primary bg-primary/5 mb-6 rounded-md border-l-4 p-4"
        role="note"
        aria-labelledby="note-heading"
      >
        <p id="note-heading" class="mb-2 font-medium">
          {locale === 'en'
            ? 'Note: Feed is a Structure, Not a Widget'
            : '注意: Feed はウィジェットではなくストラクチャー'}
        </p>
        <p class="text-muted-foreground text-sm">
          {locale === 'en' ? (
            <>
              Unlike widget patterns (e.g., Listbox, Menu), the feed pattern is a{' '}
              <strong>structure</strong>. This means assistive technologies can use their default
              reading mode when navigating feed content. The feed role enables users to navigate
              articles using Page Up/Down while still allowing natural reading within each article.
            </>
          ) : (
            <>
              ウィジェットパターン（例: Listbox、Menu）とは異なり、Feed パターンは
              <strong>ストラクチャー</strong>
              です。これは支援技術がフィードコンテンツをナビゲートする際にデフォルトの読み上げモードを使用できることを意味します。Feed
              ロールにより、ユーザーは Page Up/Down
              で記事間を移動しながら、各記事内では自然な読み上げが可能になります。
            </>
          )}
        </p>
      </div>
    )
  }

  {
    properties && properties.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{h('section.ariaProperties')}</h3>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
                <th class="py-2 pr-4 text-left">{h('table.target')}</th>
                <th class="py-2 pr-4 text-left">{h('table.values')}</th>
                <th class="py-2 pr-4 text-left">{h('table.required')}</th>
                <th class="py-2 text-left">{h('table.description')}</th>
              </tr>
            </thead>
            <tbody>
              {properties.map((prop) => {
                const values = t(prop.values);
                const notes = prop.notes ? t(prop.notes) : '';

                // Determine required text
                let requiredText = prop.required ? h('value.yes') : h('value.no');
                if (notes.includes('conditional') || notes.includes('条件付き')) {
                  requiredText =
                    locale === 'en'
                      ? notes.replace(/[^(]*\((.*)\).*/, '$1') || 'Conditional*'
                      : '条件付き*';
                }

                return (
                  <tr class="border-border border-b">
                    <td class="py-2 pr-4">
                      <code>{prop.attribute}</code>
                    </td>
                    <td class="py-2 pr-4">{t(prop.element)}</td>
                    <td class="py-2 pr-4">{values}</td>
                    <td class="py-2 pr-4">{requiredText}</td>
                    <td class="py-2">{notes.replace(/\s*\(.*\)/, '')}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </ResponsiveTable>
        {additionalNotes && additionalNotes[0] && (
          <p class="text-muted-foreground mb-6 text-sm">{t(additionalNotes[0])}</p>
        )}
      </>
    )
  }

  {
    states && states.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{h('section.ariaStates')}</h3>
        {states.map((state) => (
          <div class="mb-6">
            <h4 class="mb-2 font-medium">
              <code>{state.attribute}</code>
            </h4>
            {state.description && <p class="text-muted-foreground mb-3">{t(state.description)}</p>}
            <ResponsiveTable class="mb-2">
              <table class="w-full border-collapse">
                <tbody>
                  <tr class="border-border border-b">
                    <td class="w-32 py-2 pr-4 font-medium">{h('table.target')}</td>
                    <td class="py-2">{t(state.element)}</td>
                  </tr>
                  <tr class="border-border border-b">
                    <td class="py-2 pr-4 font-medium">{h('table.values')}</td>
                    <td class="py-2">
                      {t(state.values)
                        .split(' | ')
                        .map((v: string, i: number, arr: string[]) => (
                          <>
                            <code>{v.trim()}</code>
                            {i < arr.length - 1 && ' | '}
                          </>
                        ))}
                    </td>
                  </tr>
                  <tr class="border-border border-b">
                    <td class="py-2 pr-4 font-medium">{h('table.required')}</td>
                    <td class="py-2">
                      {locale === 'en'
                        ? 'Conditional (when loading occurs)'
                        : '条件付き（読み込みが発生する場合）'}
                    </td>
                  </tr>
                  {state.changeTrigger && (
                    <tr class="border-border border-b">
                      <td class="py-2 pr-4 font-medium">{h('table.changeTrigger')}</td>
                      <td class="py-2">{t(state.changeTrigger)}</td>
                    </tr>
                  )}
                  {state.reference && (
                    <tr class="border-border border-b">
                      <td class="py-2 pr-4 font-medium">{h('table.reference')}</td>
                      <td class="py-2">
                        <ExternalLink href={state.reference} class="text-primary hover:underline">
                          {state.attribute}
                        </ExternalLink>
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </ResponsiveTable>
            {additionalNotes && additionalNotes[2] && (
              <p class="text-muted-foreground mt-2 text-sm">
                <strong>{locale === 'en' ? 'Note:' : '注意:'}</strong> {t(additionalNotes[2])}
              </p>
            )}
          </div>
        ))}
      </>
    )
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.keyboardSupport')}</h3>
  <ResponsiveTable class="mb-4">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.key')}</th>
          <th class="py-2 text-left">{h('table.action')}</th>
        </tr>
      </thead>
      <tbody>
        {
          keyboardSupport?.map((shortcut) => {
            const keyText = t(shortcut.key);
            return (
              <tr class="border-border border-b">
                <td class="py-2 pr-4">
                  {keyText.includes('+') ? (
                    <>
                      {keyText.split(' + ').map((k: string, i: number, arr: string[]) => (
                        <>
                          <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                            {k.trim()}
                          </kbd>
                          {i < arr.length - 1 && ' + '}
                        </>
                      ))}
                    </>
                  ) : (
                    <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">{keyText}</kbd>
                  )}
                </td>
                <td class="py-2">{t(shortcut.action)}</td>
              </tr>
            );
          })
        }
      </tbody>
    </table>
  </ResponsiveTable>
  {
    additionalNotes && additionalNotes[1] && (
      <p class="text-muted-foreground mb-4 text-sm">
        <strong>
          {locale === 'en'
            ? 'Why Page Up/Down instead of Arrow keys?'
            : 'なぜ矢印キーではなく Page Up/Down なのか？'}
        </strong>{' '}
        {locale === 'en'
          ? 'Feeds contain long-form content like articles. Using Page Up/Down allows users to navigate between articles while Arrow keys remain available for reading within articles.'
          : 'フィードには記事のような長文コンテンツが含まれます。Page Up/Down を使用することで、ユーザーは記事間を移動でき、矢印キーは記事内の読み上げに使用できます。'}
      </p>
    )
  }

  {
    keyboardDocNote && (
      <div
        class="mb-6 rounded-md border-l-4 border-amber-500 bg-amber-500/5 p-4"
        role="note"
        aria-labelledby="keyboard-docs-note"
      >
        <p id="keyboard-docs-note" class="mb-2 font-medium">
          {locale === 'en'
            ? 'Important: Keyboard Documentation'
            : '重要: キーボード操作のドキュメント'}
        </p>
        <p class="text-muted-foreground text-sm">
          {locale === 'en' ? (
            <>
              The Feed pattern uses Page Up/Down for navigation, which differs from common widget
              patterns that use Arrow keys. As the{' '}
              <ExternalLink
                href="https://www.w3.org/WAI/ARIA/apg/patterns/feed/"
                class="text-primary hover:underline"
              >
                APG specification
              </ExternalLink>{' '}
              notes:{' '}
              <em>
                "Due to the lack of convention, providing easily discoverable keyboard interface
                documentation is especially important."
              </em>{' '}
              Always display keyboard hints near the feed to help users discover these navigation
              options.
            </>
          ) : (
            <>
              Feed パターンは Page Up/Down
              でナビゲートしますが、これは矢印キーを使用する一般的なウィジェットパターンとは異なります。
              <ExternalLink
                href="https://www.w3.org/WAI/ARIA/apg/patterns/feed/"
                class="text-primary hover:underline"
              >
                APG 仕様
              </ExternalLink>
              には次のように記載されています:{' '}
              <em>
                「慣習がないため、簡単に発見できるキーボードインターフェースのドキュメントを提供することが特に重要です。」
              </em>
              ユーザーがこれらのナビゲーションオプションを発見できるよう、フィードの近くにキーボード操作のヒントを常に表示してください。
            </>
          )}
        </p>
      </div>
    )
  }

  {
    focusManagement && focusManagement.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{h('section.focusManagement')}</h3>
        <ResponsiveTable class="mb-4">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.event')}</th>
                <th class="py-2 text-left">{h('table.behavior')}</th>
              </tr>
            </thead>
            <tbody>
              {focusManagement.map((item) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">{t(item.event)}</td>
                  <td
                    class="py-2"
                    set:html={t(item.behavior).replace(/<([^>]+)>/g, '&lt;$1&gt;')}
                  />
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    )
  }
</div>
