---
import { ResponsiveTable } from '@/components/ui/table';
import { feedAccessibilityData } from './accessibility-data';
import { localize } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;

const testing = feedAccessibilityData.testing;
if (!testing) {
  throw new Error('Testing data not found in accessibility-data.ts');
}

const { strategies, categories, commands } = testing;

// Localization helper
const t = localize(locale);

// Priority colors
const priorityColors = {
  high: 'bg-red-500',
  medium: 'bg-yellow-500',
  low: 'bg-green-500',
};

// Section titles
const sectionTitles = {
  en: {
    intro:
      'Tests verify APG compliance across ARIA structure, keyboard navigation, focus management, and dynamic loading states. The Feed component uses a two-layer testing strategy.',
    testingStrategy: 'Testing Strategy',
    testCategories: 'Test Categories',
    runningTests: 'Running Tests',
    unitTests: 'Unit Tests',
    e2eTests: 'E2E Tests',
  },
  ja: {
    intro:
      'テストは ARIA 構造、キーボードナビゲーション、フォーカス管理、動的読み込み状態の観点で APG 準拠を検証します。Feed コンポーネントは2層のテスト戦略を使用しています。',
    testingStrategy: 'テスト戦略',
    testCategories: 'テストカテゴリ',
    runningTests: 'テストの実行',
    unitTests: 'ユニットテスト',
    e2eTests: 'E2E テスト',
  },
};

const titles = sectionTitles[locale];
---

<div class="prose dark:prose-invert max-w-none">
  <p class="text-muted-foreground mb-4">
    {titles.intro}
  </p>

  <h3 class="mb-3 text-lg font-medium">{titles.testingStrategy}</h3>

  {
    strategies.map((strategy) => (
      <div class="bg-muted/50 mb-6 rounded-lg p-4">
        <h4 class="mb-2 font-medium">{t(strategy.title)}</h4>
        <p class="text-muted-foreground mb-2 text-sm">{t(strategy.description)}</p>
        <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
          {strategy.areas.map((area) => (
            <li>{t(area)}</li>
          ))}
        </ul>
      </div>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{titles.testCategories}</h3>

  {
    categories.map((category) => (
      <>
        <h4 class="mb-2 flex items-center gap-2 font-medium">
          <span class={`inline-block h-3 w-3 rounded-full ${priorityColors[category.priority]}`} />
          {locale === 'en' ? (
            <>
              {category.priority === 'high'
                ? 'High Priority'
                : category.priority === 'medium'
                  ? 'Medium Priority'
                  : 'Low Priority'}
              : {t(category.title)} ({category.testType})
            </>
          ) : (
            <>
              {category.priority === 'high'
                ? '高優先度'
                : category.priority === 'medium'
                  ? '中優先度'
                  : '低優先度'}
              : {t(category.title)}（{category.testType}）
            </>
          )}
        </h4>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{locale === 'en' ? 'Test' : 'テスト'}</th>
                <th class="py-2 text-left">{locale === 'en' ? 'Description' : '説明'}</th>
              </tr>
            </thead>
            <tbody>
              {category.items.map((item) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{item.name}</code>
                  </td>
                  <td class="py-2">{t(item.description)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{titles.runningTests}</h3>

  {
    commands && (
      <>
        <div class="bg-muted/50 mb-6 rounded-lg p-4">
          <h4 class="mb-2 font-medium">{titles.unitTests}</h4>
          <pre class="text-muted-foreground overflow-x-auto text-sm">
            <code>
              {commands
                .filter((cmd) => {
                  const comment = t(cmd.comment);
                  return (
                    comment.toLowerCase().includes('unit') ||
                    comment.includes('ユニット') ||
                    comment.includes('framework')
                  );
                })
                .map((cmd) => {
                  const comment = t(cmd.comment);
                  return comment ? `# ${comment}\n${cmd.command}` : cmd.command;
                })
                .join('\n\n')}
            </code>
          </pre>
        </div>

        <div class="bg-muted/50 mb-6 rounded-lg p-4">
          <h4 class="mb-2 font-medium">{titles.e2eTests}</h4>
          <pre class="text-muted-foreground overflow-x-auto text-sm">
            <code>
              {commands
                .filter((cmd) => {
                  const comment = t(cmd.comment);
                  return (
                    comment.toLowerCase().includes('e2e') ||
                    comment.toLowerCase().includes('ui mode') ||
                    comment.includes('UI モード')
                  );
                })
                .map((cmd) => {
                  const comment = t(cmd.comment);
                  return comment ? `# ${comment}\n${cmd.command}` : cmd.command;
                })
                .join('\n\n')}
            </code>
          </pre>
        </div>
      </>
    )
  }
</div>
