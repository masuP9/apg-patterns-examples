---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import { gridAccessibilityData } from './accessibility-data';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;

const {
  roles,
  properties,
  states,
  keyboardSections,
  focusManagement,
  additionalNotes,
  nativeHtmlConsiderations,
  references,
} = gridAccessibilityData;

// Create localization function
const t = localize(locale);
const h = createTableHeaderTranslator(locale);
---

<div class="prose dark:prose-invert max-w-none">
  <h3 class="mb-3 text-lg font-medium">
    {locale === 'en' ? 'Native HTML vs Grid Role' : 'ネイティブHTMLとGridロール'}
  </h3>
  <p class="text-muted-foreground mb-4">
    {
      locale === 'en' ? (
        <>
          The <code>grid</code> role creates an interactive data grid with 2D keyboard navigation.
          For static data tables, use native <code>&lt;table&gt;</code> elements instead. Use{' '}
          <code>grid</code> when:
        </>
      ) : (
        <>
          <code>grid</code>
          ロールは、2Dキーボードナビゲーションを備えたインタラクティブなデータグリッドを作成します。静的なデータテーブルには、代わりにネイティブの
          <code>&lt;table&gt;</code>要素を使用してください。<code>grid</code>
          は以下の場合に使用します：
        </>
      )
    }
  </p>
  <ul class="text-muted-foreground mb-6 list-inside list-disc space-y-2">
    {nativeHtmlConsiderations?.map((item) => <li>{t(item.useCase)}</li>)}
  </ul>

  <h3 class="mb-3 text-lg font-medium">{h('section.ariaRoles')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.role')}</th>
          <th class="py-2 pr-4 text-left">{h('table.element')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          roles.map((role) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{role.name}</code>
              </td>
              <td class="py-2 pr-4">{t(role.element)}</td>
              <td class="py-2">{t(role.description)}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  {
    references && references.length > 0 && (
      <p class="text-muted-foreground mb-6 text-sm">
        <ExternalLink href={references[0].url} class="text-primary hover:underline">
          {references[0].title}
        </ExternalLink>
      </p>
    )
  }

  <h3 class="mb-3 text-lg font-medium">
    {
      locale === 'en'
        ? 'WAI-ARIA Properties (Grid Container)'
        : 'WAI-ARIA プロパティ（グリッドコンテナ）'
    }
  </h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
          <th class="py-2 pr-4 text-left">{h('table.values')}</th>
          <th class="py-2 pr-4 text-left">{h('table.required')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          properties?.map((prop) => {
            let requiredText: string;
            if (typeof prop.required === 'boolean') {
              requiredText = prop.required ? h('value.yes') : h('value.no');
            } else {
              const localizedReq = t(prop.required);
              requiredText = localizedReq.includes('*')
                ? locale === 'en'
                  ? 'Yes*'
                  : 'はい*'
                : localizedReq;
            }

            return (
              <tr class="border-border border-b">
                <td class="py-2 pr-4">
                  <code>{prop.attribute}</code>
                </td>
                <td class="py-2 pr-4">{t(prop.values)}</td>
                <td class="py-2 pr-4">{requiredText}</td>
                <td class="py-2">{prop.notes ? t(prop.notes) : ''}</td>
              </tr>
            );
          })
        }
      </tbody>
    </table>
  </ResponsiveTable>
  {
    additionalNotes && additionalNotes[0] && (
      <p class="text-muted-foreground mb-6 text-sm">* {t(additionalNotes[0])}</p>
    )
  }

  <h3 class="mb-3 text-lg font-medium">
    {locale === 'en' ? 'WAI-ARIA States (Grid Cells)' : 'WAI-ARIA ステート（グリッドセル）'}
  </h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
          <th class="py-2 pr-4 text-left">{h('table.values')}</th>
          <th class="py-2 pr-4 text-left">{h('table.required')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          states?.map((state) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{state.attribute}</code>
              </td>
              <td class="py-2 pr-4">
                {t(state.values)
                  .split(' | ')
                  .map((v, i, arr) => (
                    <>
                      <code>{v.trim()}</code>
                      {i < arr.length - 1 && ' | '}
                    </>
                  ))}
              </td>
              <td class="py-2 pr-4">{state.required ? h('value.yes') : `${h('value.no')}*`}</td>
              <td class="py-2">{state.changeTrigger ? t(state.changeTrigger) : ''}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">
    {
      locale === 'en'
        ? '* When selection is supported, ALL gridcells should have aria-selected.'
        : '* 選択をサポートする場合、すべてのgridcellにaria-selectedが必要です。'
    }
  </p>

  <h3 class="mb-3 text-lg font-medium">{h('section.keyboardSupport')}</h3>
  {
    keyboardSections?.map((section) => (
      <>
        <h4 class="mb-2 font-medium">{t(section.title || '')}</h4>
        <ResponsiveTable class="mb-4">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.key')}</th>
                <th class="py-2 text-left">{h('table.action')}</th>
              </tr>
            </thead>
            <tbody>
              {section.shortcuts.map((shortcut) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    {shortcut.key.includes('+') ? (
                      <>
                        {shortcut.key.split(' + ').map((k, i, arr) => (
                          <>
                            <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                              {k.trim()}
                            </kbd>
                            {i < arr.length - 1 && ' + '}
                          </>
                        ))}
                      </>
                    ) : (
                      <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                        {shortcut.key}
                      </kbd>
                    )}
                  </td>
                  <td class="py-2">{t(shortcut.action)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.focusManagement')}</h3>
  <p class="text-muted-foreground mb-4">
    {
      locale === 'en' ? (
        <>
          This component uses <strong>roving tabindex</strong> for focus management:
        </>
      ) : (
        <>
          このコンポーネントはフォーカス管理に<strong>roving tabindex</strong>を使用します：
        </>
      )
    }
  </p>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    {focusManagement?.map((item) => <li set:html={t(item.behavior)} />)}
  </ul>

  <h3 class="mb-3 text-lg font-medium">
    {locale === 'en' ? 'Disabled Cells' : '無効化セル'}
  </h3>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    {
      locale === 'en' ? (
        <>
          <li>
            Have <code>aria-disabled="true"</code>
          </li>
          <li>Are focusable (included in keyboard navigation)</li>
          <li>Cannot be selected or activated</li>
          <li>Visually distinct (e.g., grayed out)</li>
        </>
      ) : (
        <>
          <li>
            <code>aria-disabled="true"</code>を持つ
          </li>
          <li>フォーカス可能（キーボードナビゲーションに含まれる）</li>
          <li>選択またはアクティベートできない</li>
          <li>視覚的に区別される（例：グレーアウト）</li>
        </>
      )
    }
  </ul>
</div>
