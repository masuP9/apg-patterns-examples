---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import type { Locale } from '@/i18n';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import { listboxAccessibilityData } from './accessibility-data';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;
const t = localize(locale);
const h = createTableHeaderTranslator(locale);
const data = listboxAccessibilityData;
---

<div class="prose dark:prose-invert max-w-none">
  <h3 class="mb-3 text-lg font-medium">{h('section.ariaRoles')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.role')}</th>
          <th class="py-2 pr-4 text-left">{h('table.element')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          data.roles.map((role) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{role.name}</code>
              </td>
              <td class="py-2 pr-4">
                <Fragment set:html={t(role.element)} />
              </td>
              <td class="py-2">{t(role.description)}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">
    <ExternalLink href="https://w3c.github.io/aria/#listbox" class="text-primary hover:underline">
      WAI-ARIA listbox role
    </ExternalLink>
  </p>

  <h3 class="mb-3 text-lg font-medium">{h('section.ariaProperties')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
          <th class="py-2 pr-4 text-left">{h('table.target')}</th>
          <th class="py-2 pr-4 text-left">{h('table.values')}</th>
          <th class="py-2 pr-4 text-left">{h('table.required')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          data.properties?.map((prop) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{prop.attribute}</code>
              </td>
              <td class="py-2 pr-4">{t(prop.element)}</td>
              <td class="py-2 pr-4">
                <Fragment set:html={t(prop.values)} />
              </td>
              <td class="py-2 pr-4">
                {typeof prop.required === 'boolean'
                  ? prop.required
                    ? h('value.yes')
                    : h('value.no')
                  : t(prop.required)}
              </td>
              <td class="py-2">{prop.notes ? t(prop.notes) : ''}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">
    {
      locale === 'ja'
        ? '* aria-label または aria-labelledby のいずれかが必須'
        : '* Either aria-label or aria-labelledby is required'
    }
  </p>

  <h3 class="mb-3 text-lg font-medium">{h('section.ariaStates')}</h3>
  {
    data.states?.map((state) => (
      <div class="mb-6">
        <h4 class="mb-2 font-medium">
          <code>{state.attribute}</code>
        </h4>
        <p class="text-muted-foreground mb-3">
          {state.attribute === 'aria-selected'
            ? locale === 'ja'
              ? 'オプションが選択されているかどうかを示します。'
              : 'Indicates whether an option is selected.'
            : locale === 'ja'
              ? 'オプションが選択不可であることを示します。'
              : 'Indicates that an option is not selectable.'}
        </p>
        <ResponsiveTable class="mb-2">
          <table class="w-full border-collapse">
            <tbody>
              <tr class="border-border border-b">
                <td class="w-32 py-2 pr-4 font-medium">{h('table.target')}</td>
                <td class="py-2">{t(state.element)}</td>
              </tr>
              <tr class="border-border border-b">
                <td class="py-2 pr-4 font-medium">{h('table.values')}</td>
                <td class="py-2">
                  <Fragment set:html={t(state.values)} />
                </td>
              </tr>
              <tr class="border-border border-b">
                <td class="py-2 pr-4 font-medium">{h('table.required')}</td>
                <td class="py-2">
                  {state.required
                    ? h('value.yes')
                    : locale === 'ja'
                      ? 'いいえ（無効時のみ）'
                      : 'No (only when disabled)'}
                </td>
              </tr>
              {state.changeTrigger && (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4 font-medium">{h('table.changeTrigger')}</td>
                  <td class="py-2">{t(state.changeTrigger)}</td>
                </tr>
              )}
              {state.reference && (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4 font-medium">{h('table.reference')}</td>
                  <td class="py-2">
                    <ExternalLink href={state.reference} class="text-primary hover:underline">
                      {state.attribute}
                    </ExternalLink>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </ResponsiveTable>
      </div>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.keyboardSupport')}</h3>
  {
    data.keyboardSections?.map((section) => (
      <>
        <h4 class="mb-2 font-medium">{t(section.title || '')}</h4>
        <ResponsiveTable class="mb-4">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.key')}</th>
                <th class="py-2 text-left">{h('table.action')}</th>
              </tr>
            </thead>
            <tbody>
              {section.shortcuts.map((shortcut) => {
                const keyText = t(shortcut.key);
                return (
                  <tr class="border-border border-b">
                    <td class="py-2 pr-4">
                      {keyText.includes(' / ') ? (
                        <>
                          <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                            {keyText.split(' / ')[0]}
                          </kbd>{' '}
                          /{' '}
                          <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                            {keyText.split(' / ')[1]}
                          </kbd>
                        </>
                      ) : keyText.includes(' + ') ? (
                        <>
                          <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                            {keyText.split(' + ')[0]}
                          </kbd>{' '}
                          +{' '}
                          <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                            {keyText.split(' + ')[1]}
                          </kbd>
                        </>
                      ) : keyText === 'Type character' ||
                        keyText === 'Arrow keys' ||
                        keyText === '文字入力' ||
                        keyText === '矢印キー' ? (
                        keyText
                      ) : (
                        <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">{keyText}</kbd>
                      )}
                    </td>
                    <td class="py-2">{t(shortcut.action)}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.focusManagement')}</h3>
  <p class="text-muted-foreground mb-4">
    {
      locale === 'ja'
        ? 'このコンポーネントは、フォーカス管理にローヴィングタブインデックスパターンを使用します:'
        : 'This component uses the Roving Tabindex pattern for focus management:'
    }
  </p>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    {data.focusManagement?.map((rule) => <li>{t(rule.behavior)}</li>)}
  </ul>

  {
    data.additionalNotes && (
      <>
        <h3 class="mb-3 text-lg font-medium">
          {locale === 'ja' ? '選択モデル' : 'Selection Model'}
        </h3>
        <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
          {data.additionalNotes.map((note) => (
            <li>
              <Fragment set:html={t(note)} />
            </li>
          ))}
        </ul>
      </>
    )
  }
</div>
