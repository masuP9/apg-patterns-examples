---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import CodeBlock from '@/components/ui/CodeBlock.astro';
import fs from 'node:fs';
import path from 'node:path';

// Read actual test file at build time
const e2eTestPath = path.join(process.cwd(), 'e2e/listbox.spec.ts');
const e2eTestCode = fs.readFileSync(e2eTestPath, 'utf-8');
---

<div class="prose dark:prose-invert max-w-none">
  <p class="text-muted-foreground mb-4">
    テストは、ARIA属性、キーボード操作、選択動作、アクセシビリティ要件全般にわたってAPG準拠を検証します。
    Listboxコンポーネントは2層のテスト戦略を採用しています。
  </p>

  <h3 class="mb-3 text-lg font-medium">テスト戦略</h3>

  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <h4 class="mb-2 font-medium">ユニットテスト（Testing Library）</h4>
    <p class="text-muted-foreground mb-2 text-sm">
      フレームワーク固有のテストライブラリを使用して、コンポーネントのレンダリング出力を検証します。
      正しいHTML構造とARIA属性を確認します。
    </p>
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      <li>ARIA属性（role、aria-selected、aria-multiselectable など）</li>
      <li>キーボード操作（矢印キー、Space、Home/End など）</li>
      <li>選択動作（単一選択、複数選択）</li>
      <li>jest-axeによるアクセシビリティ</li>
    </ul>
  </div>

  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <h4 class="mb-2 font-medium">E2Eテスト（Playwright）</h4>
    <p class="text-muted-foreground mb-2 text-sm">
      全フレームワークで実際のブラウザ環境でコンポーネントの動作を検証します。
      インタラクションとクロスフレームワークの一貫性をカバーします。
    </p>
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      <li>キーボードナビゲーション（単一選択、複数選択、水平方向）</li>
      <li>マウス操作（クリック選択、トグル）</li>
      <li>ライブブラウザでのARIA構造</li>
      <li>ローヴィングタブインデックスによるフォーカス管理</li>
      <li>タイプアヘッド文字ナビゲーション</li>
      <li>axe-coreアクセシビリティスキャン</li>
      <li>クロスフレームワーク一貫性チェック</li>
    </ul>
  </div>

  <h3 class="mb-3 text-lg font-medium">テストカテゴリ</h3>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: APG キーボード操作（Unit + E2E）
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>ArrowDown/Up</code></td>
          <td class="py-2">オプション間でフォーカスを移動（垂直方向）</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>ArrowRight/Left</code></td>
          <td class="py-2">オプション間でフォーカスを移動（水平方向）</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Home/End</code></td>
          <td class="py-2">最初/最後のオプションにフォーカスを移動</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Disabled skip</code></td>
          <td class="py-2">ナビゲーション中に無効化されたオプションをスキップ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Selection follows focus</code></td>
          <td class="py-2">単一選択: 矢印キーで選択が変更される</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Space toggle</code></td>
          <td class="py-2">複数選択: Spaceでオプションの選択をトグル</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Shift+Arrow</code></td>
          <td class="py-2">複数選択: 選択範囲を拡張</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Shift+Home/End</code></td>
          <td class="py-2">複数選択: アンカーから最初/最後まで選択</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Ctrl+A</code></td>
          <td class="py-2">複数選択: すべてのオプションを選択</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Type-ahead</code></td>
          <td class="py-2">文字入力で一致するオプションにフォーカス</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Type-ahead cycle</code></td>
          <td class="py-2">同じ文字の繰り返し入力で一致項目を巡回</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: APG ARIA 属性（Unit + E2E）
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="listbox"</code></td>
          <td class="py-2">コンテナがlistboxロールを持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="option"</code></td>
          <td class="py-2">各オプションがoptionロールを持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-selected</code></td>
          <td class="py-2">選択されたオプションが <code>aria-selected="true"</code> を持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-multiselectable</code></td>
          <td class="py-2">複数選択が有効な場合にリストボックスが属性を持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-orientation</code></td>
          <td class="py-2">水平/垂直方向を反映</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-disabled</code></td>
          <td class="py-2">無効化されたオプションが <code>aria-disabled="true"</code> を持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-label/labelledby</code></td>
          <td class="py-2">リストボックスがアクセシブル名を持つ</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: フォーカス管理 - ローヴィングタブインデックス（Unit + E2E）
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>tabIndex=0</code></td>
          <td class="py-2">フォーカス中のオプションがtabIndex=0を持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>tabIndex=-1</code></td>
          <td class="py-2">フォーカスされていないオプションがtabIndex=-1を持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Disabled tabIndex</code></td>
          <td class="py-2">無効化されたオプションがtabIndex=-1を持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Focus restoration</code></td>
          <td class="py-2">再入時に正しいオプションにフォーカスが戻る</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
    中優先度: アクセシビリティ（Unit + E2E）
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>axe violations</code></td>
          <td class="py-2">WCAG 2.1 AA違反がないこと（jest-axe/axe-core経由）</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
    中優先度: マウス操作（E2E）
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Click option</code></td>
          <td class="py-2">クリックでオプションを選択（単一選択）</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Click toggle</code></td>
          <td class="py-2">クリックで選択をトグル（複数選択）</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Click disabled</code></td>
          <td class="py-2">無効化されたオプションは選択できない</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-green-500"></span>
    低優先度: クロスフレームワーク一貫性（E2E）
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>All frameworks have listbox</code></td>
          <td class="py-2">React、Vue、Svelte、Astro全てがlistbox要素をレンダリング</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Consistent ARIA</code></td>
          <td class="py-2">全フレームワークで一貫したARIA構造</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Select on click</code></td>
          <td class="py-2">全フレームワークでクリック時に正しく選択</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>Keyboard navigation</code></td>
          <td class="py-2">全フレームワークでキーボードナビゲーションが一貫して動作</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h3 class="mb-3 text-lg font-medium">テストコード例</h3>
  <p class="text-muted-foreground mb-4 text-sm">
    以下は実際のE2Eテストファイル（<code>e2e/listbox.spec.ts</code>）です。
  </p>
  <CodeBlock
    code={e2eTestCode}
    lang="typescript"
    title="e2e/listbox.spec.ts"
    collapsible
    collapsedLines={20}
  />

  <h3 class="mb-3 text-lg font-medium">テストツール</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    <li>
      <ExternalLink href="https://vitest.dev/" class="text-primary hover:underline"
        >Vitest</ExternalLink
      >
      - ユニットテスト用テストランナー
    </li>
    <li>
      <ExternalLink href="https://testing-library.com/" class="text-primary hover:underline"
        >Testing Library</ExternalLink
      >
      - フレームワーク固有のテストユーティリティ（React、Vue、Svelte）
    </li>
    <li>
      <ExternalLink href="https://playwright.dev/" class="text-primary hover:underline"
        >Playwright</ExternalLink
      >
      - E2Eテスト用ブラウザ自動化
    </li>
    <li>
      <ExternalLink
        href="https://github.com/dequelabs/axe-core-npm/tree/develop/packages/playwright"
        class="text-primary hover:underline">axe-core/playwright</ExternalLink
      >
      - E2Eでの自動アクセシビリティテスト
    </li>
  </ul>

  <p class="text-muted-foreground text-sm">
    完全なドキュメントは <ExternalLink
      href="https://github.com/masuP9/apg-patterns-examples/blob/main/.internal/testing-strategy.md"
      class="text-primary hover:underline">testing-strategy.md</ExternalLink
    > を参照してください。
  </p>
</div>
