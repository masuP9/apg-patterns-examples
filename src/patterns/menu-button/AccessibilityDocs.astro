---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import { menuButtonAccessibilityData } from './accessibility-data';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;

const {
  roles,
  properties,
  states,
  keyboardSections,
  focusManagement,
  additionalNotes,
  references,
} = menuButtonAccessibilityData;

// Create localization function
const t = localize(locale);
const h = createTableHeaderTranslator(locale);

// Section titles for this pattern
const sectionTitles = {
  en: {
    propertiesButton: 'WAI-ARIA Properties (Button)',
    propertiesMenu: 'WAI-ARIA Properties (Menu)',
    hiddenState: 'Hidden State',
    hiddenStateDesc: 'When closed, the menu uses both hidden and inert attributes to:',
    hiddenStatePoints: [
      'Hide the menu from visual display',
      'Remove the menu from the accessibility tree',
      'Prevent keyboard and mouse interaction with hidden items',
    ],
    accessibleNameNote: 'Either aria-labelledby or aria-label is required for an accessible name',
  },
  ja: {
    propertiesButton: 'WAI-ARIA プロパティ（ボタン）',
    propertiesMenu: 'WAI-ARIA プロパティ（メニュー）',
    hiddenState: '非表示状態',
    hiddenStateDesc: '閉じているとき、メニューはhiddenとinert属性の両方を使用して以下を実現します:',
    hiddenStatePoints: [
      '視覚的な表示からメニューを隠す',
      'アクセシビリティツリーからメニューを削除する',
      '非表示のアイテムに対するキーボードとマウスの操作を防ぐ',
    ],
    accessibleNameNote:
      'aria-labelledbyまたはaria-labelのいずれかがアクセシブルな名前のために必須です',
  },
};

const titles = sectionTitles[locale];

// Separate button and menu properties
const buttonProperties = properties?.filter((p) => p.element === 'button') || [];
const menuProperties = properties?.filter((p) => p.element !== 'button') || [];
---

<div class="prose dark:prose-invert max-w-none">
  <h3 class="mb-3 text-lg font-medium">{h('section.ariaRoles')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.role')}</th>
          <th class="py-2 pr-4 text-left">{h('table.element')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          roles.map((role) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{role.name}</code>
              </td>
              <td class="py-2 pr-4">{t(role.element)}</td>
              <td class="py-2">{t(role.description)}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  {
    references && references.length > 0 && (
      <p class="text-muted-foreground mb-6 text-sm">
        <ExternalLink href={references[0].url} class="text-primary hover:underline">
          {references[0].title}
        </ExternalLink>
      </p>
    )
  }

  {
    buttonProperties.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{titles.propertiesButton}</h3>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
                <th class="py-2 pr-4 text-left">{h('table.values')}</th>
                <th class="py-2 pr-4 text-left">{h('table.required')}</th>
                <th class="py-2 text-left">{h('table.description')}</th>
              </tr>
            </thead>
            <tbody>
              {buttonProperties.map((prop) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{prop.attribute}</code>
                  </td>
                  <td class="py-2 pr-4">
                    <code>{t(prop.values)}</code>
                  </td>
                  <td class="py-2 pr-4">
                    {typeof prop.required === 'boolean'
                      ? prop.required
                        ? h('value.yes')
                        : h('value.no')
                      : t(prop.required)}
                  </td>
                  <td class="py-2">{prop.notes ? t(prop.notes) : ''}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    )
  }

  {
    menuProperties.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{titles.propertiesMenu}</h3>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
                <th class="py-2 pr-4 text-left">{h('table.target')}</th>
                <th class="py-2 pr-4 text-left">{h('table.values')}</th>
                <th class="py-2 pr-4 text-left">{h('table.required')}</th>
                <th class="py-2 text-left">{h('table.description')}</th>
              </tr>
            </thead>
            <tbody>
              {menuProperties.map((prop) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{prop.attribute}</code>
                  </td>
                  <td class="py-2 pr-4">{prop.element}</td>
                  <td class="py-2 pr-4">
                    <code>{t(prop.values)}</code>
                  </td>
                  <td class="py-2 pr-4">
                    {typeof prop.required === 'boolean'
                      ? prop.required
                        ? h('value.yes')
                        : h('value.no')
                      : t(prop.required)}
                  </td>
                  <td class="py-2">{prop.notes ? t(prop.notes) : ''}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
        <p class="text-muted-foreground mb-6 text-sm">* {titles.accessibleNameNote}</p>
      </>
    )
  }

  {
    states && states.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{h('section.ariaStates')}</h3>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
                <th class="py-2 pr-4 text-left">{h('table.target')}</th>
                <th class="py-2 pr-4 text-left">{h('table.values')}</th>
                <th class="py-2 pr-4 text-left">{h('table.required')}</th>
                <th class="py-2 text-left">{h('table.changeTrigger')}</th>
              </tr>
            </thead>
            <tbody>
              {states.map((state) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{state.attribute}</code>
                  </td>
                  <td class="py-2 pr-4">{state.element}</td>
                  <td class="py-2 pr-4">
                    {state.values.split(' | ').map((v, i, arr) => (
                      <>
                        <code>{v.trim()}</code>
                        {i < arr.length - 1 && ' | '}
                      </>
                    ))}
                  </td>
                  <td class="py-2 pr-4">{state.required ? h('value.yes') : h('value.no')}</td>
                  <td class="py-2">{state.changeTrigger ? t(state.changeTrigger) : ''}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    )
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.keyboardSupport')}</h3>
  {
    keyboardSections?.map((section) => (
      <>
        {section.title && <h4 class="mb-2 font-medium">{t(section.title)}</h4>}
        <ResponsiveTable class="mb-4">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.key')}</th>
                <th class="py-2 text-left">{h('table.action')}</th>
              </tr>
            </thead>
            <tbody>
              {section.shortcuts.map((shortcut) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    {shortcut.key.includes('/') || shortcut.key.includes('+') ? (
                      <Fragment>
                        {shortcut.key.split(/\s*[/+]\s*/).map((k, i, arr) => (
                          <>
                            <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                              {k.trim()}
                            </kbd>
                            {i < arr.length - 1 && (shortcut.key.includes('+') ? ' + ' : ' / ')}
                          </>
                        ))}
                      </Fragment>
                    ) : shortcut.key === 'Type character' || shortcut.key === '文字を入力' ? (
                      t(shortcut.key)
                    ) : (
                      <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                        {shortcut.key}
                      </kbd>
                    )}
                  </td>
                  <td class="py-2">{t(shortcut.action)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }

  {
    focusManagement && focusManagement.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{h('section.focusManagement')}</h3>
        <p class="text-muted-foreground mb-4">
          {locale === 'en'
            ? 'This component uses the Roving Tabindex pattern for focus management:'
            : 'このコンポーネントは、フォーカス管理にRoving Tabindexパターンを使用します:'}
        </p>
        <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
          {focusManagement.map((rule) => (
            <li>
              {t(rule.event)}
              {typeof rule.behavior === 'string' && rule.behavior.includes('tabIndex')
                ? `: ${rule.behavior}`
                : `: ${t(rule.behavior)}`}
            </li>
          ))}
        </ul>
      </>
    )
  }

  <h3 class="mb-3 text-lg font-medium">{titles.hiddenState}</h3>
  <p class="text-muted-foreground mb-4">
    {titles.hiddenStateDesc}
  </p>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    {titles.hiddenStatePoints.map((point) => <li>{point}</li>)}
  </ul>
</div>
