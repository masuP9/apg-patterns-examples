---
import type { Locale } from '@/i18n';
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import { menubarAccessibilityData } from './accessibility-data';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;
const data = menubarAccessibilityData;
const t = localize(locale);
const th = createTableHeaderTranslator(locale);

const translations = {
  en: {
    menubarItemsTitle: 'WAI-ARIA Properties (Menubar Items)',
    menuSubmenuTitle: 'WAI-ARIA Properties (Menu/Submenu)',
    menubarItemNote: '* Only for items with a submenu',
    menuSubmenuNote: '** Either aria-labelledby or aria-label is required for an accessible name',
    differencesTitle: 'Differences from Menu-Button',
    hiddenStateTitle: 'Hidden State',
    hiddenStateDesc: 'When closed, the menu uses aria-hidden="true" with CSS to:',
    openStateDesc: 'When open, the menu has aria-hidden="false" with visibility: visible.',
  },
  ja: {
    menubarItemsTitle: 'WAI-ARIA プロパティ（メニューバーアイテム）',
    menuSubmenuTitle: 'WAI-ARIA プロパティ（メニュー/サブメニュー）',
    menubarItemNote: '* サブメニューを持つアイテムのみ',
    menuSubmenuNote:
      '** aria-labelledbyまたはaria-labelのいずれかがアクセシブルな名前のために必須です',
    differencesTitle: 'Menu-Button との違い',
    hiddenStateTitle: '非表示状態',
    hiddenStateDesc: '閉じているとき、メニューはaria-hidden="true"とCSSを使用して以下を実現します:',
    openStateDesc: '開いているとき、メニューはaria-hidden="false"とvisibility: visibleになります。',
  },
};

const tt = translations[locale];

// Split properties into menubar items and menu/submenu
const menubarItemProps =
  data.properties?.filter(
    (p) => p.attribute === 'aria-haspopup' || p.attribute === 'aria-expanded'
  ) ?? [];

const menuSubmenuProps =
  data.properties?.filter(
    (p) => p.attribute !== 'aria-haspopup' && p.attribute !== 'aria-expanded'
  ) ?? [];

// Comparison table data
const comparisonData = {
  en: [
    {
      feature: 'Top-level structure',
      menuButton: '<button> trigger',
      menubar: '<ul role="menubar"> (always visible)',
    },
    { feature: 'Horizontal navigation', menuButton: 'None', menubar: '←/→ between menubar items' },
    { feature: 'Hover behavior', menuButton: 'None', menubar: 'Auto-switch when menu is open' },
    {
      feature: '<li> role',
      menuButton: 'Not always specified',
      menubar: 'role="none" required for all',
    },
  ],
  ja: [
    {
      feature: 'トップレベル構造',
      menuButton: '<button>トリガー',
      menubar: '<ul role="menubar">（常に表示）',
    },
    { feature: '水平ナビゲーション', menuButton: 'なし', menubar: 'メニューバーアイテム間で←/→' },
    {
      feature: 'ホバー動作',
      menuButton: 'なし',
      menubar: 'メニューが開いているときに自動切り替え',
    },
    {
      feature: '<li>のロール',
      menuButton: '常に指定されるとは限らない',
      menubar: 'すべてにrole="none"が必須',
    },
  ],
};

// Hidden state bullet points
const hiddenStateBullets = {
  en: [
    'Hide the menu from screen readers (aria-hidden)',
    'Hide the menu visually (visibility: hidden)',
    'Prevent pointer interaction (pointer-events: none)',
    'Enable smooth CSS animations on open/close',
  ],
  ja: [
    'スクリーンリーダーからメニューを隠す（aria-hidden）',
    '視覚的にメニューを隠す（visibility: hidden）',
    'ポインター操作を防ぐ（pointer-events: none）',
    '開閉時のスムーズなCSSアニメーションを可能にする',
  ],
};
---

<div class="prose dark:prose-invert max-w-none">
  <!-- WAI-ARIA Roles -->
  <h3 class="mb-3 text-lg font-medium">{th('section.ariaRoles')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{th('table.role')}</th>
          <th class="py-2 pr-4 text-left">{th('table.element')}</th>
          <th class="py-2 text-left">{th('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          data.roles.map((role) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{role.name}</code>
              </td>
              <td class="py-2 pr-4">
                <Fragment
                  set:html={t(role.element)
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/&lt;(\w+)&gt;/g, '<code>&lt;$1&gt;</code>')}
                />
              </td>
              <td class="py-2">{t(role.description)}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">
    <ExternalLink href="https://w3c.github.io/aria/#menubar" class="text-primary hover:underline">
      WAI-ARIA menubar role
    </ExternalLink>
  </p>

  <!-- WAI-ARIA Properties (Menubar Items) -->
  <h3 class="mb-3 text-lg font-medium">{tt.menubarItemsTitle}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{th('table.attribute')}</th>
          <th class="py-2 pr-4 text-left">{th('table.values')}</th>
          <th class="py-2 pr-4 text-left">{th('table.required')}</th>
          <th class="py-2 text-left">{th('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          menubarItemProps.map((prop) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{prop.attribute}</code>
              </td>
              <td class="py-2 pr-4">
                <Fragment
                  set:html={t(prop.values)
                    .replace(/\|/g, ' | ')
                    .replace(/(\w+)/g, '<code>$1</code>')
                    .replace(
                      /<code>"<\/code><code>menu<\/code><code>"<\/code>/g,
                      '<code>"menu"</code>'
                    )}
                />
              </td>
              <td class="py-2 pr-4">
                {typeof prop.required === 'boolean'
                  ? prop.required
                    ? th('value.yes')
                    : th('value.no')
                  : t(prop.required)}
              </td>
              <td class="py-2">
                <Fragment
                  set:html={t(prop.notes ?? '')
                    .replace(/(<code>.*?<\/code>)/g, '$1')
                    .replace(/"([^"]+)"/g, '<code>"$1"</code>')}
                />
              </td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">{tt.menubarItemNote}</p>

  <!-- WAI-ARIA Properties (Menu/Submenu) -->
  <h3 class="mb-3 text-lg font-medium">{tt.menuSubmenuTitle}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{th('table.attribute')}</th>
          <th class="py-2 pr-4 text-left">{th('table.target')}</th>
          <th class="py-2 pr-4 text-left">{th('table.values')}</th>
          <th class="py-2 pr-4 text-left">{th('table.required')}</th>
          <th class="py-2 text-left">{th('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          menuSubmenuProps.map((prop) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{prop.attribute}</code>
              </td>
              <td class="py-2 pr-4">{t(prop.element)}</td>
              <td class="py-2 pr-4">
                <Fragment
                  set:html={t(prop.values)
                    .split(' | ')
                    .map((v) => `<code>${v}</code>`)
                    .join(' | ')}
                />
              </td>
              <td class="py-2 pr-4">
                {typeof prop.required === 'boolean'
                  ? prop.required
                    ? th('value.yes')
                    : th('value.no')
                  : t(prop.required)}
              </td>
              <td class="py-2">{t(prop.notes ?? '')}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">
    {tt.menuSubmenuNote}
  </p>

  <!-- Keyboard Support -->
  <h3 class="mb-3 text-lg font-medium">{th('section.keyboardSupport')}</h3>
  {
    data.keyboardSections?.map((section) => (
      <>
        {section.title && <h4 class="mb-2 font-medium">{t(section.title)}</h4>}
        <ResponsiveTable class="mb-4">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{th('table.key')}</th>
                <th class="py-2 text-left">{th('table.action')}</th>
              </tr>
            </thead>
            <tbody>
              {section.shortcuts.map((shortcut) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    {t(shortcut.key)
                      .split(' / ')
                      .map((k, i) => (
                        <>
                          {i > 0 && ' / '}
                          <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">{k}</kbd>
                        </>
                      ))}
                  </td>
                  <td class="py-2">{t(shortcut.action)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }

  <!-- Focus Management -->
  <h3 class="mb-3 text-lg font-medium">{th('section.focusManagement')}</h3>
  <p class="text-muted-foreground mb-4">
    {
      locale === 'ja'
        ? 'このコンポーネントは、フォーカス管理に<strong>Roving Tabindex</strong>パターンを使用します:'
        : 'This component uses the <strong>Roving Tabindex</strong> pattern for focus management:'
    }
  </p>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    {
      data.focusManagement?.map((rule) => (
        <li>
          <Fragment
            set:html={t(rule.behavior)
              .replace(/tabindex="(-?\d+)"/g, '<code>tabindex="$1"</code>')
              .replace(/tabindex="-1"/g, '<code>tabindex="-1"</code>')}
          />
        </li>
      ))
    }
  </ul>

  <!-- Differences from Menu-Button -->
  <h3 class="mb-3 text-lg font-medium">{tt.differencesTitle}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{locale === 'ja' ? '機能' : 'Feature'}</th>
          <th class="py-2 pr-4 text-left">Menu-Button</th>
          <th class="py-2 text-left">Menubar</th>
        </tr>
      </thead>
      <tbody>
        {
          comparisonData[locale].map((row) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">{row.feature}</td>
              <td class="py-2 pr-4">
                <Fragment
                  set:html={row.menuButton.replace(/<(\w+)>/g, '<code>&lt;$1&gt;</code>')}
                />
              </td>
              <td class="py-2">
                <Fragment
                  set:html={row.menubar
                    .replace(/<([^>]+)>/g, '<code>&lt;$1&gt;</code>')
                    .replace(/←\/→/g, '<code>←</code>/<code>→</code>')}
                />
              </td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>

  <!-- Hidden State -->
  <h3 class="mb-3 text-lg font-medium">{tt.hiddenStateTitle}</h3>
  <p class="text-muted-foreground mb-4">
    {tt.hiddenStateDesc}
  </p>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    {
      hiddenStateBullets[locale].map((bullet) => (
        <li>
          <Fragment
            set:html={bullet.replace(/([a-z-]+: [a-z]+|aria-hidden)/g, '<code>$1</code>')}
          />
        </li>
      ))
    }
  </ul>
  <p class="text-muted-foreground mb-4">
    <Fragment
      set:html={tt.openStateDesc.replace(
        /(aria-hidden="false"|visibility: visible)/g,
        '<code>$1</code>'
      )}
    />
  </p>
</div>
