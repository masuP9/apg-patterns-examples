---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import CodeBlock from '@/components/ui/CodeBlock.astro';
import fs from 'node:fs';
import path from 'node:path';
import { tableAccessibilityData } from './accessibility-data';
import { localize } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;

// Read actual test file at build time
const e2eTestPath = path.join(process.cwd(), 'e2e/table.spec.ts');
const e2eTestCode = fs.readFileSync(e2eTestPath, 'utf-8');

const testing = tableAccessibilityData.testing;
if (!testing) {
  throw new Error('Testing data not found in accessibility-data.ts');
}

const { categories, tools } = testing;

// Localization helper
const t = localize(locale);

// Priority colors
const priorityColors = {
  high: 'bg-red-500',
  medium: 'bg-yellow-500',
  low: 'bg-green-500',
};

// Section titles
const sectionTitles = {
  en: {
    intro:
      'Tests verify APG compliance for ARIA roles, table structure, and accessibility requirements. Since Table is a static structure, keyboard interaction tests are not applicable.',
    testCategories: 'Test Categories',
    testingTools: 'Testing Tools',
    e2eTestCode: 'E2E Test Code',
    e2eTestCodeDescription:
      'The following Playwright tests verify Table behavior across all four frameworks (React, Vue, Svelte, Astro). Tests cover ARIA structure, sort state, virtualization attributes, and visual cell spanning.',
    visualSpanningNote:
      'Visual spanning tests use getBoundingClientRect() and require a real browser environment (Vitest browser mode with Playwright). These tests are in *.browser.test.ts files.',
  },
  ja: {
    intro:
      'テストはARIAロール、テーブル構造、アクセシビリティ要件についてのAPG準拠を検証します。Tableは静的な構造であるため、キーボードインタラクションのテストは該当しません。',
    testCategories: 'テストカテゴリ',
    testingTools: 'テストツール',
    e2eTestCode: 'E2Eテストコード',
    e2eTestCodeDescription:
      '以下のPlaywrightテストは、4つのフレームワーク（React、Vue、Svelte、Astro）すべてでTableの動作を検証します。ARIA構造、ソート状態、仮想化属性、視覚的セル結合をカバーしています。',
    visualSpanningNote:
      '視覚的スパンテストはgetBoundingClientRect()を使用し、実際のブラウザ環境（Vitest browser mode + Playwright）が必要です。これらのテストは*.browser.test.tsファイルにあります。',
  },
};

const titles = sectionTitles[locale];
---

<div class="prose dark:prose-invert max-w-none">
  <p class="text-muted-foreground mb-4">
    {titles.intro}
  </p>

  <h3 class="mb-3 text-lg font-medium">{titles.testCategories}</h3>

  {
    categories.map((category) => (
      <>
        <h4 class="mb-2 flex items-center gap-2 font-medium">
          <span class={`inline-block h-3 w-3 rounded-full ${priorityColors[category.priority]}`} />
          {locale === 'en' ? (
            <>
              {category.priority === 'high'
                ? 'High Priority'
                : category.priority === 'medium'
                  ? 'Medium Priority'
                  : 'Low Priority'}
              : {t(category.title)}
            </>
          ) : (
            <>
              {category.priority === 'high'
                ? '高優先度'
                : category.priority === 'medium'
                  ? '中優先度'
                  : '低優先度'}
              : {t(category.title)}
            </>
          )}
        </h4>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{locale === 'en' ? 'Test' : 'テスト'}</th>
                <th class="py-2 text-left">{locale === 'en' ? 'Description' : '説明'}</th>
              </tr>
            </thead>
            <tbody>
              {category.items.map((item) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{item.name}</code>
                  </td>
                  <td class="py-2">{t(item.description)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
        {category.title.en === 'Visual Cell Spanning (Browser Tests)' && (
          <p class="text-muted-foreground mb-6 text-sm">
            <strong>{locale === 'en' ? 'Note:' : '注意:'}</strong> {titles.visualSpanningNote}
          </p>
        )}
      </>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{titles.testingTools}</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    {
      tools.map((tool) => (
        <li>
          <ExternalLink href={tool.url} class="text-primary hover:underline">
            {tool.name}
          </ExternalLink>
          {' - '}
          {t(tool.description)}
        </li>
      ))
    }
  </ul>

  <h3 class="mb-3 text-lg font-medium">{titles.e2eTestCode}</h3>
  <p class="text-muted-foreground mb-4 text-sm">
    {titles.e2eTestCodeDescription}
  </p>
  <CodeBlock
    collapsible
    collapsedLines={30}
    code={e2eTestCode}
    lang="typescript"
    title="e2e/table.spec.ts"
  />
</div>
