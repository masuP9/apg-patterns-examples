---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import CodeBlock from '@/components/ui/CodeBlock.astro';
import fs from 'node:fs';
import path from 'node:path';

// Read actual test file at build time
const e2eTestPath = path.join(process.cwd(), 'e2e/table.spec.ts');
const e2eTestCode = fs.readFileSync(e2eTestPath, 'utf-8');
---

<div class="prose dark:prose-invert max-w-none">
  <p class="text-muted-foreground mb-4">
    テストは ARIA ロール、テーブル構造、アクセシビリティ要件についての APG 準拠を検証します。Table
    は静的な構造であるため、キーボードインタラクションのテストは該当しません。
  </p>

  <h3 class="mb-3 text-lg font-medium">テスト戦略</h3>

  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <h4 class="mb-2 font-medium">単体テスト（Testing Library）</h4>
    <p class="text-muted-foreground mb-2 text-sm">
      フレームワーク固有のテストライブラリを使用して、コンポーネントのレンダリング出力を検証します。
      これらのテストは正しいHTML構造とARIA属性を確認します。
    </p>
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      <li>ARIA ロール（table, row, cell, columnheader, rowheader, rowgroup）</li>
      <li>aria-label または aria-labelledby によるアクセシブルな名前</li>
      <li>ソート状態属性（aria-sort）</li>
      <li>仮想化属性（aria-rowcount, aria-colcount, aria-rowindex）</li>
      <li>jest-axe によるアクセシビリティ</li>
    </ul>
  </div>

  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <h4 class="mb-2 font-medium">E2E テスト（Playwright）</h4>
    <p class="text-muted-foreground mb-2 text-sm">
      すべてのフレームワークで実際のブラウザ環境でコンポーネントの動作を検証します。
      これらのテストは視覚的なレンダリングとクロスフレームワークの一貫性をカバーします。
    </p>
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      <li>ライブブラウザでの ARIA 構造検証</li>
      <li>ソートのインタラクションと状態変化</li>
      <li>視覚的セル結合（colspan, rowspan の寸法）</li>
      <li>axe-core によるアクセシビリティスキャン</li>
      <li>クロスフレームワークの一貫性チェック</li>
    </ul>
  </div>

  <h3 class="mb-3 text-lg font-medium">テストカテゴリ</h3>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: ARIA 構造
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="table"</code></td>
          <td class="py-2">コンテナ要素が table ロールを持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="rowgroup"</code></td>
          <td class="py-2">ヘッダーとボディグループが rowgroup ロールを持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="row"</code></td>
          <td class="py-2">すべての行が row ロールを持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="columnheader"</code></td>
          <td class="py-2">ヘッダーセルが columnheader ロールを持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="rowheader"</code></td>
          <td class="py-2">指定時に行ヘッダーセルが rowheader ロールを持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>role="cell"</code></td>
          <td class="py-2">データセルが cell ロールを持つ</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: アクセシブルな名前
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-label</code></td>
          <td class="py-2">aria-label 属性によるアクセシブルな名前</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-labelledby</code></td>
          <td class="py-2">外部要素参照によるアクセシブルな名前</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>caption</code></td>
          <td class="py-2">提供時にキャプションが表示される</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-red-500"></span>
    高優先度: ソート状態
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-sort="ascending"</code></td>
          <td class="py-2">昇順でソートされた列</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-sort="descending"</code></td>
          <td class="py-2">降順でソートされた列</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-sort="none"</code></td>
          <td class="py-2">現在ソートされていないソート可能な列</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-sort なし</code></td>
          <td class="py-2">ソート不可の列には aria-sort 属性がない</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>onSortChange コールバック</code></td>
          <td class="py-2">ソートボタンクリック時にコールバックが呼び出される</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>ソートトグル</code></td>
          <td class="py-2">ソート済み列をクリックすると方向が切り替わる</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
    中優先度: 仮想化サポート
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-colcount</code></td>
          <td class="py-2">仮想化テーブルの総列数</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-rowcount</code></td>
          <td class="py-2">仮想化テーブルの総行数</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-rowindex</code></td>
          <td class="py-2">テーブル全体における行の位置</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>aria-colindex</code></td>
          <td class="py-2">テーブル全体におけるセルの位置</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
    中優先度: 視覚的セル結合（ブラウザテスト）
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>colspan 幅</code></td>
          <td class="py-2">colspan=2 のセルが通常セルの約2倍の幅を持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>rowspan 高さ</code></td>
          <td class="py-2">rowspan=2 のセルが通常セルの約2倍の高さを持つ</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>全列スパン</code></td>
          <td class="py-2">全列にまたがるセルがテーブル幅と一致する</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>複合スパン</code></td>
          <td class="py-2">colspan と rowspan の両方を持つセルが正しい寸法を持つ</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>
  <p class="text-muted-foreground mb-6 text-sm">
    <strong>注意:</strong> 視覚的スパンテストは <code>getBoundingClientRect()</code>
    を使用し、実際のブラウザ環境（Vitest browser mode + Playwright）が必要です。これらのテストは
    <code>*.browser.test.ts</code> ファイルにあります。
  </p>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
    中優先度: アクセシビリティ
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>axe 違反</code></td>
          <td class="py-2">axe-core によるアクセシビリティ違反なし</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>ソート可能列</code></td>
          <td class="py-2">ソート可能な列ヘッダーで違反なし</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>行ヘッダー</code></td>
          <td class="py-2">行ヘッダーセルで違反なし</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>空のテーブル</code></td>
          <td class="py-2">データ行が空でも違反なし</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-yellow-500"></span>
    中優先度: エッジケース
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>空の行</code></td>
          <td class="py-2">データ行なしでテーブルが正しくレンダリングされる</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>単一列</code></td>
          <td class="py-2">テーブルが単一列を正しく処理する</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h4 class="mb-2 flex items-center gap-2 font-medium">
    <span class="inline-block h-3 w-3 rounded-full bg-green-500"></span>
    低優先度: HTML 属性継承
  </h4>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">テスト</th>
          <th class="py-2 text-left">説明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>className</code></td>
          <td class="py-2">カスタムクラスがコンテナに適用される</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>id</code></td>
          <td class="py-2">id 属性が正しく設定される</td>
        </tr>
        <tr class="border-border border-b">
          <td class="py-2 pr-4"><code>data-*</code></td>
          <td class="py-2">data 属性がパススルーされる</td>
        </tr>
      </tbody>
    </table>
  </ResponsiveTable>

  <h3 class="mb-3 text-lg font-medium">テストツール</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    <li>
      <strong>React:</strong>
      <ExternalLink
        href="https://testing-library.com/docs/react-testing-library/intro/"
        class="text-primary hover:underline"
      >
        React Testing Library
      </ExternalLink>
    </li>
    <li>
      <strong>Vue:</strong>
      <ExternalLink
        href="https://testing-library.com/docs/vue-testing-library/intro/"
        class="text-primary hover:underline"
      >
        Vue Testing Library
      </ExternalLink>
    </li>
    <li>
      <strong>Svelte:</strong>
      <ExternalLink
        href="https://testing-library.com/docs/svelte-testing-library/intro/"
        class="text-primary hover:underline"
      >
        Svelte Testing Library
      </ExternalLink>
    </li>
    <li>
      <strong>Astro:</strong> Web Components 単体テスト用の Vitest + JSDOM
    </li>
    <li>
      <strong>E2E:</strong>
      <ExternalLink href="https://playwright.dev/" class="text-primary hover:underline">
        Playwright
      </ExternalLink>
    </li>
    <li>
      <strong>アクセシビリティ:</strong>
      <ExternalLink
        href="https://github.com/dequelabs/axe-core"
        class="text-primary hover:underline"
      >
        axe-core
      </ExternalLink>
    </li>
  </ul>

  <h3 class="mb-3 text-lg font-medium">E2E テストコード</h3>
  <p class="text-muted-foreground mb-4 text-sm">
    以下の Playwright テストは、4つのフレームワーク（React、Vue、Svelte、Astro）すべてで Table
    の動作を検証します。ARIA 構造、ソート状態、仮想化属性、視覚的セル結合をカバーしています。
  </p>
  <CodeBlock
    collapsible
    collapsedLines={30}
    code={e2eTestCode}
    lang="typescript"
    title="e2e/table.spec.ts"
  />
</div>
