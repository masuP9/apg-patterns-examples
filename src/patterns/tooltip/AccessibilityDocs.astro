---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import { tooltipAccessibilityData } from './accessibility-data';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';
import { isLocalizedText } from '@/lib/pattern-data/types';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;
const t = localize(locale);
const h = createTableHeaderTranslator(locale);
const data = tooltipAccessibilityData;

// Helper to display required field (boolean or localized)
function displayRequired(required: boolean | { en: string; ja: string }): string {
  if (typeof required === 'boolean') {
    return required ? h('value.yes') : h('value.no');
  }
  return isLocalizedText(required) ? t(required) : String(required);
}
---

<div class="prose dark:prose-invert max-w-none">
  <h3 class="mb-3 text-lg font-medium">{h('section.ariaRoles')}</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    {
      data.roles.map((role) => (
        <li>
          <code>{role.name}</code> - {t(role.description)}
          <br />
          {data.references?.find((r) => r.title.includes(role.name)) && (
            <ExternalLink
              href={data.references.find((r) => r.title.includes(role.name))!.url}
              class="text-primary text-sm hover:underline"
            >
              WAI-ARIA {role.name} role
            </ExternalLink>
          )}
        </li>
      ))
    }
  </ul>

  <h3 class="mb-3 text-lg font-medium">
    {locale === 'ja' ? 'WAI-ARIA ステート & プロパティ' : 'WAI-ARIA States & Properties'}
  </h3>

  {
    data.properties?.map((prop) => (
      <div class="mb-6">
        <h4 class="mb-2 font-medium">
          <code>{prop.attribute}</code>
        </h4>
        <p class="text-muted-foreground mb-3">{t(prop.notes || '')}</p>
        <ResponsiveTable class="mb-2">
          <table class="w-full border-collapse">
            <tbody>
              <tr class="border-border border-b">
                <td class="w-32 py-2 pr-4 font-medium">
                  {locale === 'ja' ? '適用先' : 'Applied to'}
                </td>
                <td class="py-2">{t(prop.element)}</td>
              </tr>
              {prop.attribute === 'aria-describedby' && (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4 font-medium">{locale === 'ja' ? 'タイミング' : 'When'}</td>
                  <td class="py-2">
                    {locale === 'ja'
                      ? 'ツールチップが表示されている時のみ'
                      : 'Only when tooltip is visible'}
                  </td>
                </tr>
              )}
              {prop.attribute === 'aria-hidden' && (
                <>
                  <tr class="border-border border-b">
                    <td class="py-2 pr-4 font-medium">{locale === 'ja' ? '値' : 'Values'}</td>
                    <td class="py-2">
                      <code>true</code>
                      {locale === 'ja' ? '（非表示）' : ' (hidden)'} | <code>false</code>
                      {locale === 'ja' ? '（表示）' : ' (visible)'}
                    </td>
                  </tr>
                  <tr class="border-border border-b">
                    <td class="py-2 pr-4 font-medium">
                      {locale === 'ja' ? 'デフォルト' : 'Default'}
                    </td>
                    <td class="py-2">
                      <code>true</code>
                    </td>
                  </tr>
                </>
              )}
              {prop.specUrl && (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4 font-medium">{locale === 'ja' ? '参照' : 'Reference'}</td>
                  <td class="py-2">
                    <ExternalLink href={prop.specUrl} class="text-primary hover:underline">
                      {prop.attribute}
                    </ExternalLink>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </ResponsiveTable>
      </div>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.keyboardSupport')}</h3>
  <ResponsiveTable class="mb-4">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.key')}</th>
          <th class="py-2 text-left">{h('table.action')}</th>
        </tr>
      </thead>
      <tbody>
        {
          data.keyboardSupport?.map((kbd) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">{kbd.key}</kbd>
              </td>
              <td class="py-2">{t(kbd.action)}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>

  <h3 class="mb-3 text-lg font-medium">{h('section.focusManagement')}</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    {data.focusManagement?.map((rule) => <li set:html={t(rule.behavior)} />)}
  </ul>

  <h3 class="mb-3 text-lg font-medium">{h('section.mousePointerBehavior')}</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    {data.mousePointerBehavior?.map((item) => <li set:html={t(item)} />)}
  </ul>

  <h3 class="mb-3 text-lg font-medium">{h('section.importantNotes')}</h3>
  <div
    class="mb-6 rounded-lg border border-amber-200 bg-amber-50 p-4 dark:border-amber-800 dark:bg-amber-900/20"
  >
    <p class="text-sm text-amber-800 dark:text-amber-200">
      <strong>{locale === 'ja' ? '注意:' : 'Note:'}</strong>{' '}
      {data.workInProgress && t(data.workInProgress)}
      <ExternalLink
        href={data.apgUrl}
        class="ml-1 text-amber-700 hover:underline dark:text-amber-300"
      >
        View APG Tooltip Pattern
      </ExternalLink>
    </p>
  </div>

  <h3 class="mb-3 text-lg font-medium">{h('section.visualDesign')}</h3>
  <p class="text-muted-foreground mb-3">
    {
      locale === 'ja'
        ? 'この実装は、ツールチップの視認性のベストプラクティスに従っています:'
        : 'This implementation follows best practices for tooltip visibility:'
    }
  </p>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    {data.visualDesign?.map((item) => <li set:html={t(item)} />)}
  </ul>
</div>
