---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import CodeBlock from '@/components/ui/CodeBlock.astro';
import fs from 'node:fs';
import path from 'node:path';
import { tooltipAccessibilityData } from './accessibility-data';
import { localize } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;
const t = localize(locale);
const data = tooltipAccessibilityData.testing!;

// Read actual test file at build time
const e2eTestPath = path.join(process.cwd(), data.e2eTestFile || 'e2e/tooltip.spec.ts');
const e2eTestCode = fs.readFileSync(e2eTestPath, 'utf-8');

// Helper to get priority badge color
function getPriorityColor(priority: string): string {
  switch (priority) {
    case 'high':
      return 'bg-red-500';
    case 'medium':
      return 'bg-yellow-500';
    case 'low':
      return 'bg-green-500';
    default:
      return 'bg-gray-500';
  }
}
---

<div class="prose dark:prose-invert max-w-none">
  <p class="text-muted-foreground mb-4">
    {t(data.strategies[0].description)}
  </p>

  <h3 class="mb-3 text-lg font-medium">
    {locale === 'ja' ? 'テスト戦略' : 'Testing Strategy'}
  </h3>

  {
    data.strategies.map((strategy) => (
      <div class="bg-muted/50 mb-6 rounded-lg p-4">
        <h4 class="mb-2 font-medium">{t(strategy.title)}</h4>
        <p class="text-muted-foreground mb-2 text-sm">{t(strategy.description)}</p>
        <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
          {strategy.areas.map((area) => (
            <li>{t(area)}</li>
          ))}
        </ul>
      </div>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">
    {locale === 'ja' ? 'テストカテゴリ' : 'Test Categories'}
  </h3>

  {
    data.categories.map((category) => (
      <>
        <h4 class="mb-2 flex items-center gap-2 font-medium">
          <span
            class={`inline-block h-3 w-3 rounded-full ${getPriorityColor(category.priority)}`}
          />
          {t(category.title)} ({category.testType})
        </h4>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{locale === 'ja' ? 'テスト' : 'Test'}</th>
                <th class="py-2 text-left">
                  {category.priority === 'high'
                    ? locale === 'ja'
                      ? 'APG要件'
                      : 'APG Requirement'
                    : category.priority === 'medium'
                      ? locale === 'ja'
                        ? 'WCAG要件'
                        : 'WCAG Requirement'
                      : locale === 'ja'
                        ? '説明'
                        : 'Description'}
                </th>
              </tr>
            </thead>
            <tbody>
              {category.items.map((item) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{item.name}</code>
                  </td>
                  <td class="py-2">{t(item.description)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">
    {locale === 'ja' ? 'テストコード例' : 'Example Test Code'}
  </h3>
  <p class="text-muted-foreground mb-4 text-sm">
    {
      locale === 'ja'
        ? `以下は実際のE2Eテストファイル（${data.e2eTestFile}）です。`
        : `The following is the actual E2E test file (${data.e2eTestFile}).`
    }
  </p>
  <CodeBlock
    code={e2eTestCode}
    lang="typescript"
    title={data.e2eTestFile}
    collapsible
    collapsedLines={20}
  />

  <h3 class="mb-3 text-lg font-medium">
    {locale === 'ja' ? 'テストの実行' : 'Running Tests'}
  </h3>
  <pre
    class="overflow-x-auto rounded-lg bg-gray-100 p-4 text-sm dark:bg-gray-800"><code>{data.commands.map((cmd) => {
      const comment = t(cmd.comment);
      return comment ? `# ${comment}\n${cmd.command}` : cmd.command;
    }).join('\n\n')}</code></pre>

  <h3 class="mb-3 text-lg font-medium">
    {locale === 'ja' ? 'テストツール' : 'Testing Tools'}
  </h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    {
      data.tools.map((tool) => (
        <li>
          <ExternalLink href={tool.url} class="text-primary hover:underline">
            {tool.name}
          </ExternalLink>{' '}
          - {t(tool.description)}
        </li>
      ))
    }
  </ul>

  {
    data.documentationLink && (
      <p class="text-muted-foreground text-sm">
        {locale === 'ja' ? '完全なドキュメントは ' : 'See '}
        <ExternalLink href={data.documentationLink} class="text-primary hover:underline">
          testing-strategy.md
        </ExternalLink>
        {locale === 'ja' ? ' を参照してください。' : ' for full documentation.'}
      </p>
    )
  }
</div>
