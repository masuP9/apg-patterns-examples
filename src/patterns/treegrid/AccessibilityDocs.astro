---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import { treegridAccessibilityData } from './accessibility-data';
import { localize, createTableHeaderTranslator } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;

const {
  roles,
  properties,
  states,
  keyboardSections,
  focusManagement,
  additionalNotes,
  references,
} = treegridAccessibilityData;

// Create localization function
const t = localize(locale);
const h = createTableHeaderTranslator(locale);

// Section titles
const sectionTitles = {
  en: {
    treegridVsGrid: 'TreeGrid vs Grid',
    keyDifferencesFromGrid: 'Key Differences from Grid',
    treegridVsGridNote:
      "The treegrid role combines Grid's 2D keyboard navigation with TreeView's hierarchical expand/collapse functionality. Key differences from Grid:",
    propertyFootnote: '* Either aria-label or aria-labelledby is required.',
    stateFootnoteExpanded:
      '* Only parent rows (with children) have aria-expanded. Leaf rows do NOT have this attribute.',
    stateFootnoteSelected: '** When selection is supported, ALL rows should have aria-selected.',
    treeOpsNote:
      'Important: Arrow keys at non-rowheader cells only move focus, they do NOT expand/collapse.',
    selectionDiff: 'Selection: Row selection (aria-selected on row) vs Cell selection in Grid',
    arrowKeysDiff: 'Arrow keys at rowheader: Expand/collapse tree vs Move focus in Grid',
    enterKeyDiff: 'Enter key: Cell activation only (never expands/collapses)',
    hierarchyDiff: 'Hierarchy: aria-level and aria-expanded required on rows',
    navigationDiff: 'Navigation: Collapsed children are skipped in navigation',
  },
  ja: {
    treegridVsGrid: 'TreeGrid vs Grid',
    keyDifferencesFromGrid: 'Gridとの主な違い',
    treegridVsGridNote:
      'treegridロールは、Gridの2Dキーボードナビゲーションと、TreeViewの階層展開/折りたたみ機能を組み合わせています。Gridとの主な違い:',
    propertyFootnote: '* aria-labelまたはaria-labelledbyのいずれかが必須です。',
    stateFootnoteExpanded:
      '* 親行（子を持つ行）のみにaria-expandedがあります。リーフ行にはこの属性はありません。',
    stateFootnoteSelected: '** 選択がサポートされている場合、すべての行にaria-selectedが必要です。',
    treeOpsNote:
      '重要: 非rowheaderセルでの矢印キーはフォーカスの移動のみで、展開/折りたたみは行いません。',
    selectionDiff: '選択: 行選択（rowのaria-selected）vs Gridのセル選択',
    arrowKeysDiff: 'rowheaderでの矢印キー: ツリーの展開/折りたたみ vs Gridのフォーカス移動',
    enterKeyDiff: 'Enterキー: セルのアクティベーションのみ（展開/折りたたみはしない）',
    hierarchyDiff: '階層: 行にaria-levelとaria-expandedが必須',
    navigationDiff: 'ナビゲーション: 折りたたまれた子はナビゲーションでスキップ',
  },
};

const titles = sectionTitles[locale];
---

<div class="prose dark:prose-invert max-w-none">
  <h3 class="mb-3 text-lg font-medium">{titles.treegridVsGrid}</h3>
  <p class="text-muted-foreground mb-4">
    {titles.treegridVsGridNote}
  </p>
  {
    additionalNotes && (
      <ul class="text-muted-foreground mb-6 list-inside list-disc space-y-2">
        {additionalNotes.map((note) => (
          <li>
            <span set:html={t(note).replace(/(aria-\w+)/g, '<code>$1</code>')} />
          </li>
        ))}
      </ul>
    )
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.ariaRoles')}</h3>
  <ResponsiveTable class="mb-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-border border-b">
          <th class="py-2 pr-4 text-left">{h('table.role')}</th>
          <th class="py-2 pr-4 text-left">{h('table.element')}</th>
          <th class="py-2 text-left">{h('table.description')}</th>
        </tr>
      </thead>
      <tbody>
        {
          roles.map((role) => (
            <tr class="border-border border-b">
              <td class="py-2 pr-4">
                <code>{role.name}</code>
              </td>
              <td class="py-2 pr-4">{t(role.element)}</td>
              <td class="py-2">{t(role.description)}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </ResponsiveTable>
  {
    references && references.length > 0 && (
      <p class="text-muted-foreground mb-6 text-sm">
        <ExternalLink
          href={references[1]?.url || references[0].url}
          class="text-primary hover:underline"
        >
          {references[1]?.title || references[0].title}
        </ExternalLink>
      </p>
    )
  }

  {
    properties && properties.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{h('section.ariaProperties')} (TreeGrid Container)</h3>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
                <th class="py-2 pr-4 text-left">{h('table.values')}</th>
                <th class="py-2 pr-4 text-left">{h('table.required')}</th>
                <th class="py-2 text-left">{h('table.description')}</th>
              </tr>
            </thead>
            <tbody>
              {properties.map((prop) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{prop.attribute}</code>
                  </td>
                  <td class="py-2 pr-4">{t(prop.values)}</td>
                  <td class="py-2 pr-4">
                    {typeof prop.required === 'boolean'
                      ? prop.required
                        ? h('value.yes')
                        : h('value.no')
                      : t(prop.required)}
                  </td>
                  <td class="py-2">{prop.notes ? t(prop.notes) : ''}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
        <p class="text-muted-foreground mb-6 text-sm">{titles.propertyFootnote}</p>
      </>
    )
  }

  {
    states && states.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{h('section.ariaStates')} (Rows)</h3>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.attribute')}</th>
                <th class="py-2 pr-4 text-left">{h('table.values')}</th>
                <th class="py-2 pr-4 text-left">{h('table.required')}</th>
                <th class="py-2 text-left">{h('table.description')}</th>
              </tr>
            </thead>
            <tbody>
              {states.map((state) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{state.attribute}</code>
                  </td>
                  <td class="py-2 pr-4">{t(state.values)}</td>
                  <td class="py-2 pr-4">
                    {state.required
                      ? h('value.yes') + (state.attribute === 'aria-expanded' ? '*' : '')
                      : h('value.no') + (state.attribute === 'aria-selected' ? '**' : '')}
                  </td>
                  <td class="py-2">{state.changeTrigger ? t(state.changeTrigger) : ''}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
        <p class="text-muted-foreground mb-6 text-sm">
          {titles.stateFootnoteExpanded}
          <br />
          {titles.stateFootnoteSelected}
        </p>
      </>
    )
  }

  <h3 class="mb-3 text-lg font-medium">{h('section.keyboardSupport')}</h3>
  {
    keyboardSections?.map((section, index) => (
      <>
        <h4 class="mb-2 font-medium">{t(section.title ?? '')}</h4>
        <ResponsiveTable class={index < keyboardSections.length - 1 ? 'mb-4' : 'mb-4'}>
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{h('table.key')}</th>
                <th class="py-2 text-left">{h('table.action')}</th>
              </tr>
            </thead>
            <tbody>
              {section.shortcuts.map((shortcut) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <kbd class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">
                      {t(shortcut.key)}
                    </kbd>
                  </td>
                  <td class="py-2">{t(shortcut.action)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }
  <p class="text-muted-foreground mb-4 text-sm">
    <strong>{locale === 'en' ? 'Important:' : '重要:'}</strong>
    {titles.treeOpsNote.replace(/^(Important:|重要:)\s*/, '')}
  </p>

  <h3 class="mb-3 text-lg font-medium">{h('section.focusManagement')}</h3>
  <p class="text-muted-foreground mb-4">
    {
      locale === 'en'
        ? 'This component uses roving tabindex for focus management:'
        : 'このコンポーネントはフォーカス管理にローヴィングタブインデックスを使用します:'
    }
  </p>
  {
    focusManagement && (
      <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
        {focusManagement.map((rule) => (
          <li>
            <span set:html={t(rule.behavior).replace(/(tabindex="-?\d")/g, '<code>$1</code>')} />
          </li>
        ))}
      </ul>
    )
  }

  <h3 class="mb-3 text-lg font-medium">{titles.keyDifferencesFromGrid}</h3>
  <ul class="text-muted-foreground mb-4 list-inside list-disc space-y-2">
    <li>
      <strong>{locale === 'en' ? 'Selection:' : '選択:'}</strong>
      {titles.selectionDiff.replace(/^(Selection:|選択:)\s*/, '')}
    </li>
    <li>
      <strong>{locale === 'en' ? 'Arrow keys at rowheader:' : 'rowheaderでの矢印キー:'}</strong>
      {titles.arrowKeysDiff.replace(/^(Arrow keys at rowheader:|rowheaderでの矢印キー:)\s*/, '')}
    </li>
    <li>
      <strong>{locale === 'en' ? 'Enter key:' : 'Enterキー:'}</strong>
      {titles.enterKeyDiff.replace(/^(Enter key:|Enterキー:)\s*/, '')}
    </li>
    <li>
      <strong>{locale === 'en' ? 'Hierarchy:' : '階層:'}</strong>
      {titles.hierarchyDiff.replace(/^(Hierarchy:|階層:)\s*/, '')}
    </li>
    <li>
      <strong>{locale === 'en' ? 'Navigation:' : 'ナビゲーション:'}</strong>
      {titles.navigationDiff.replace(/^(Navigation:|ナビゲーション:)\s*/, '')}
    </li>
  </ul>
</div>
