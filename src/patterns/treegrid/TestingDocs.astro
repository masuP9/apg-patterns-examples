---
import ExternalLink from '@/components/ui/ExternalLink.astro';
import { ResponsiveTable } from '@/components/ui/table';
import CodeBlock from '@/components/ui/CodeBlock.astro';
import fs from 'node:fs';
import path from 'node:path';
import { treegridAccessibilityData } from './accessibility-data';
import { localize } from '@/lib/pattern-data/i18n';
import type { Locale } from '@/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'en' } = Astro.props;

const testing = treegridAccessibilityData.testing;
if (!testing) {
  throw new Error('Testing data not found in accessibility-data.ts');
}

const { strategies, categories, e2eTestFile, commands, tools, documentationLink } = testing;

// Read actual test file at build time
const e2eTestCode = e2eTestFile
  ? (() => {
      try {
        return fs.readFileSync(path.join(process.cwd(), e2eTestFile), 'utf-8');
      } catch {
        return '';
      }
    })()
  : '';

// Localization helper
const t = localize(locale);

// Priority colors
const priorityColors = {
  high: 'bg-red-500',
  medium: 'bg-yellow-500',
  low: 'bg-green-500',
};

// Section titles
const sectionTitles = {
  en: {
    intro:
      'Tests verify APG compliance across keyboard interaction, ARIA attributes, and accessibility requirements. The TreeGrid component combines Grid and TreeView testing strategies.',
    testingStrategy: 'Testing Strategy',
    testCategories: 'Test Categories',
    exampleTestCode: 'Example Test Code',
    exampleTestCodeDesc: 'The following is the actual E2E test file',
    runningTests: 'Running Tests',
    testingTools: 'Testing Tools',
    seeFullDocs: 'See',
    forFullDocs: 'for full documentation.',
    test: 'Test',
    description: 'Description',
    keyDifferenceFromGrid: 'Key Difference from Grid',
    keyDifferences: [
      'Selection target: TreeGrid selects rows (aria-selected on row), Grid selects cells',
      'Arrow behavior at rowheader: ArrowRight/Left do tree operations, not cell navigation',
      'Hierarchy: Must test aria-level values and parent/child relationships',
      'Hidden rows: Must skip collapsed children during navigation',
    ],
  },
  ja: {
    intro:
      'テストは、キーボードインタラクション、ARIA属性、アクセシビリティ要件全体でAPG準拠を検証します。TreeGridコンポーネントはGridとTreeViewのテスト戦略を組み合わせています。',
    testingStrategy: 'テスト戦略',
    testCategories: 'テストカテゴリ',
    exampleTestCode: 'テストコード例',
    exampleTestCodeDesc: '以下は実際のE2Eテストファイルです',
    runningTests: 'テストの実行',
    testingTools: 'テストツール',
    seeFullDocs: '完全なドキュメントは',
    forFullDocs: 'を参照してください。',
    test: 'テスト',
    description: '説明',
    keyDifferenceFromGrid: 'Gridとの主な違い',
    keyDifferences: [
      '選択対象: TreeGridは行を選択（rowのaria-selected）、Gridはセルを選択',
      'rowheaderでの矢印の動作: ArrowRight/Leftはツリー操作を行い、セルナビゲーションは行わない',
      '階層: aria-levelの値と親子関係をテストする必要がある',
      '非表示行: ナビゲーション中に折りたたまれた子をスキップする必要がある',
    ],
  },
};

const titles = sectionTitles[locale];

const getPriorityLabel = (priority: 'high' | 'medium' | 'low') => {
  if (locale === 'ja') {
    return priority === 'high' ? '高優先度' : priority === 'medium' ? '中優先度' : '低優先度';
  }
  return priority === 'high'
    ? 'High Priority'
    : priority === 'medium'
      ? 'Medium Priority'
      : 'Low Priority';
};
---

<div class="prose dark:prose-invert max-w-none">
  <p class="text-muted-foreground mb-4">
    {titles.intro}
  </p>

  <h3 class="mb-3 text-lg font-medium">{titles.testingStrategy}</h3>

  {
    strategies.map((strategy) => (
      <div class="bg-muted/50 mb-6 rounded-lg p-4">
        <h4 class="mb-2 font-medium">{t(strategy.title)}</h4>
        <p class="text-muted-foreground mb-2 text-sm">{t(strategy.description)}</p>
        <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
          {strategy.areas.map((area) => (
            <li>{t(area)}</li>
          ))}
        </ul>
      </div>
    ))
  }

  <h3 class="mb-3 text-lg font-medium">{titles.testCategories}</h3>

  {
    categories.map((category) => (
      <>
        <h4 class="mb-2 flex items-center gap-2 font-medium">
          <span class={`inline-block h-3 w-3 rounded-full ${priorityColors[category.priority]}`} />
          {getPriorityLabel(category.priority)}: {t(category.title)}
          {locale === 'ja' ? '（' : ' ('}
          {category.testType}
          {locale === 'ja' ? '）' : ')'}
        </h4>
        <ResponsiveTable class="mb-6">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="border-border border-b">
                <th class="py-2 pr-4 text-left">{titles.test}</th>
                <th class="py-2 text-left">{titles.description}</th>
              </tr>
            </thead>
            <tbody>
              {category.items.map((item) => (
                <tr class="border-border border-b">
                  <td class="py-2 pr-4">
                    <code>{item.name}</code>
                  </td>
                  <td class="py-2">{t(item.description)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </ResponsiveTable>
      </>
    ))
  }

  {
    e2eTestCode && (
      <>
        <h3 class="mb-3 text-lg font-medium">{titles.exampleTestCode}</h3>
        <p class="text-muted-foreground mb-4 text-sm">
          {titles.exampleTestCodeDesc} (<code>{e2eTestFile}</code>).
        </p>
        <CodeBlock
          code={e2eTestCode}
          lang="typescript"
          title={e2eTestFile}
          collapsible
          collapsedLines={20}
        />
      </>
    )
  }

  {
    commands && commands.length > 0 && (
      <>
        <h3 class="mb-3 text-lg font-medium">{titles.runningTests}</h3>
        <pre class="overflow-x-auto rounded-lg bg-gray-100 p-4 text-sm dark:bg-gray-800">
          <code>
            {commands
              .map((cmd) => {
                const comment = t(cmd.comment);
                return comment ? `# ${comment}\n${cmd.command}` : cmd.command;
              })
              .join('\n\n')}
          </code>
        </pre>
      </>
    )
  }

  <h3 class="mb-3 text-lg font-medium">{titles.keyDifferenceFromGrid}</h3>
  <div class="bg-muted/50 mb-6 rounded-lg p-4">
    <ul class="text-muted-foreground list-disc space-y-1 pl-6 text-sm">
      {
        titles.keyDifferences.map((diff) => (
          <li set:html={diff.replace(/(\w+-\w+)/g, '<em>$1</em>')} />
        ))
      }
    </ul>
  </div>

  <h3 class="mb-3 text-lg font-medium">{titles.testingTools}</h3>
  <ul class="mb-6 list-disc space-y-2 pl-6">
    {
      tools.map((tool) => (
        <li>
          <ExternalLink href={tool.url} class="text-primary hover:underline">
            {tool.name}
          </ExternalLink>
          {' - '}
          {t(tool.description)}
        </li>
      ))
    }
  </ul>

  {
    documentationLink && (
      <p class="text-muted-foreground text-sm">
        {titles.seeFullDocs}{' '}
        <ExternalLink href={documentationLink} class="text-primary hover:underline">
          testing-strategy.md
        </ExternalLink>{' '}
        {titles.forFullDocs}
      </p>
    )
  }
</div>
